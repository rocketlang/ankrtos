generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === Auth & Tenant ===

model Organization {
  id        String   @id @default(cuid())
  name      String
  code      String   @unique
  type      String   @default("shipowner") // shipowner, charterer, broker, agent, cha
  country   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Beta Program Fields
  betaStatus                 String?   @default("not_enrolled") // not_enrolled, invited, enrolled, active, churned
  betaEnrolledAt             DateTime?
  betaCompletedOnboardingAt  DateTime?
  betaFeedbackScore          Int?
  betaSLAAcceptedVersion     String?
  apiKey                     String?   @unique
  apiKeyGeneratedAt          DateTime?

  users                  User[]
  vessels                Vessel[]
  charters               Charter[]
  companies              Company[]
  coas                   ContractOfAffreightment[]
  preferredVendors       PreferredVendor[]         @relation("PreferredVendors")
  vendorBlacklist        VendorBlacklist[]         @relation("VendorBlacklist")
  geofences              Geofence[]
  approvalRoutes         ApprovalRoute[]
  expiryAlerts           ExpiryAlert[]
  mentionNotifications   MentionNotification[]
  agentAppointments      AgentAppointment[]
  bunkerQuantityDisputes BunkerQuantityDispute[]
  insurancePolicies      InsurancePolicy[]
  hirePaymentSchedules   HirePaymentSchedule[]
  documentLinks          DocumentLink[]
  cashToMaster           CashToMaster[]
  teamInvitations        TeamInvitation[]
  saleListings           SaleListing[]             @relation("SellerOrg")
  buyerInterests         BuyerInterest[]           @relation("BuyerOrg")
  snpOffersBuyer         SNPOffer[]                @relation("SNPBuyerOrg")
  snpOffersSeller        SNPOffer[]                @relation("SNPSellerOrg")
  snpTransactionsBuyer   SNPTransaction[]          @relation("SNPTxBuyerOrg")
  snpTransactionsSeller  SNPTransaction[]          @relation("SNPTxSellerOrg")
  snpCommissions         SNPCommission[]
  lettersOfCredit        LetterOfCredit[]
  tradePayments          TradePayment[]
  fxExposures            FXExposure[]
  ffaPositions           FFAPosition[]
  ffaTrades              FFATrade[]
  pnlEntries             PnLEntry[]
  sanctionScreenings     SanctionScreening[]
  counterpartyRisks      CounterpartyRiskScore[]
  ubos                   UltimateBeneficialOwner[]
  communicationLogs      CommunicationLog[]
  leads                  Lead[]
  leadActivities         LeadActivity[]
  customerProfiles       CustomerProfile[]
  etsAllowances          EtsAllowance[]
  imoDcsReports          ImoDcsReport[]
  esgReports             EsgReport[]
  carbonCredits          CarbonCredit[]
  revenueForecasts       RevenueForecast[]
  fixtureAnalytics       FixtureAnalytics[]
  cashFlowEntries        CashFlowEntry[]
  tonnageHeatmaps        TonnageHeatmap[]
  employees              Employee[]
  leaveBalances          LeaveBalance[]
  attendanceLogs         AttendanceLog[]
  payslips               Payslip[]
  trainingRecords        TrainingRecord[]
  emailMessages          EmailMessage[]
  notificationDigests    NotificationDigest[]
  customsDeclarations    CustomsDeclaration[]
  hsCodeLookups          HSCodeLookup[]
  deliveryOrders         DeliveryOrder[]
  ewayBills              EwayBill[]
  portAgentAppointments  PortAgentAppointment[]
  subscriptions          Subscription[]
  featureAccessLogs      FeatureAccessLog[]
  apiUsage               ApiUsage[]
  subscriptionInvoices   SubscriptionInvoice[]
  featureFlags           FeatureFlag[]
  betaAgentProfile       BetaAgentProfile?
  betaFeedback           BetaFeedback[]
  bugReports             BugReport[]
  featureRequests        FeatureRequest[]
  emailFolders           EmailFolder[]         @relation("EmailFolders")
  emailThreads           EmailThread[]         @relation("EmailThreads")
  responseDrafts         ResponseDraft[]       @relation("ResponseDrafts")
  emailNotifications     EmailNotification[]   @relation("EmailNotifications")

  @@map("organizations")
}

model User {
  id             String    @id @default(cuid())
  email          String    @unique
  name           String
  passwordHash   String
  role           String    @default("operator") // admin, manager, operator, viewer
  organizationId String
  isActive       Boolean   @default(true)
  lastLoginAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization         Organization           @relation(fields: [organizationId], references: [id])
  vendorRatings        VendorRating[]
  subscription         Subscription?
  featureAccessLogs    FeatureAccessLog[]
  apiUsage             ApiUsage[]
  betaFeedback         BetaFeedback[]
  bugReports           BugReport[]
  featureRequests      FeatureRequest[]
  betaTrainingProgress BetaTrainingProgress[]
  knowledgeArticles    KnowledgeArticle[]
  articleProgress      ArticleProgress[]
  activityLogs         ActivityLog[]

  @@map("users")
}

// === Subscription & Access Control ===

model Subscription {
  id                   String    @id @default(cuid())
  userId               String    @unique
  organizationId       String
  tier                 String    @default("free") // free, agent, operator, enterprise
  status               String    @default("active") // active, past_due, cancelled, suspended, trialing
  startDate            DateTime  @default(now())
  endDate              DateTime?
  billingCycle         String?   @default("monthly") // monthly, annual
  amountCents          Int       @default(0)
  currency             String    @default("USD")
  features             Json?
  apiQuota             Int       @default(0)
  apiUsed              Int       @default(0)
  lastQuotaReset       DateTime?
  stripeCustomerId     String?
  stripeSubscriptionId String?
  trialEndsAt          DateTime?
  cancelledAt          DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user         User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization           @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     SubscriptionInvoice[]
  events       SubscriptionEvent[]
  apiUsage     ApiUsage[]

  @@index([userId])
  @@index([organizationId])
  @@index([tier])
  @@index([status])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id                    String   @id @default(cuid())
  tier                  String   @unique // free, agent, operator, enterprise
  name                  String
  description           String?
  priceMonthlyCents     Int
  priceAnnualCents      Int
  currency              String   @default("USD")
  features              Json
  apiQuotaMonthly       Int      @default(0)
  maxUsers              Int?
  isActive              Boolean  @default(true)
  sortOrder             Int      @default(0)
  stripeProductId       String?
  stripePriceMonthlyId  String?
  stripePriceAnnualId   String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([tier])
  @@index([isActive])
  @@map("subscription_plans")
}

model FeatureAccessLog {
  id               String   @id @default(cuid())
  userId           String
  organizationId   String
  feature          String
  action           String?
  resourceId       String?
  subscriptionTier String?
  accessGranted    Boolean  @default(true)
  denialReason     String?
  ipAddress        String?
  userAgent        String?
  accessedAt       DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([feature])
  @@index([accessedAt])
  @@index([accessGranted])
  @@map("feature_access_logs")
}

model ApiUsage {
  id               String   @id @default(cuid())
  userId           String
  organizationId   String
  subscriptionId   String
  endpoint         String
  method           String
  statusCode       Int?
  responseTimeMs   Int?
  quotaUsed        Int      @default(1)
  ipAddress        String?
  userAgent        String?
  requestAt        DateTime @default(now())

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([organizationId])
  @@index([subscriptionId])
  @@index([endpoint])
  @@index([requestAt])
  @@map("api_usage")
}

model SubscriptionInvoice {
  id                  String    @id @default(cuid())
  subscriptionId      String
  organizationId      String
  invoiceNumber       String    @unique
  amountCents         Int
  currency            String    @default("USD")
  status              String    @default("draft") // draft, open, paid, void, uncollectible
  billingPeriodStart  DateTime
  billingPeriodEnd    DateTime
  dueDate             DateTime?
  paidAt              DateTime?
  stripeInvoiceId     String?
  stripeChargeId      String?
  invoicePdfUrl       String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([organizationId])
  @@index([status])
  @@index([dueDate])
  @@map("subscription_invoices")
}

model SubscriptionEvent {
  id             String   @id @default(cuid())
  subscriptionId String
  eventType      String
  eventData      Json?
  createdBy      String?
  createdAt      DateTime @default(now())

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([eventType])
  @@index([createdAt])
  @@map("subscription_events")
}

model FeatureFlag {
  id             String    @id @default(cuid())
  organizationId String
  featureName    String
  isEnabled      Boolean   @default(false)
  enabledAt      DateTime?
  disabledAt     DateTime?
  enabledBy      String?
  notes          String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, featureName])
  @@index([organizationId])
  @@index([featureName])
  @@index([isEnabled])
  @@map("feature_flags")
}

// === Maritime Core ===

model Vessel {
  id         String  @id @default(cuid())
  imo        String  @unique // IMO number (7 digits)
  mmsi       String? @unique // Maritime Mobile Service Identity (9 digits)
  name       String
  type       String // bulk_carrier, tanker, container, general_cargo, etc.
  vesselType String? // AIS vessel type (for backwards compatibility)
  flag       String // Country flag (ISO 3166-1 alpha-2)

  // Ownership data (from Equasis)
  registeredOwner    String? // Company name
  shipManager        String? // Management company
  operator           String? // Operator company
  ownershipUpdatedAt DateTime? // Last Equasis scrape

  classificationSociety String? // DNV, LR, BV, ABS, etc.
  dwt                   Float? // Deadweight tonnage
  grt                   Float? // Gross registered tonnage
  nrt                   Float? // Net registered tonnage
  loa                   Float? // Length overall (meters)
  beam                  Float? // Beam (meters)
  draft                 Float? // Draft (meters)
  yearBuilt             Int?
  status                String  @default("active") // active, laid_up, scrapped
  organizationId        String

  organization           Organization                  @relation(fields: [organizationId], references: [id])
  voyages                Voyage[]
  charters               Charter[]
  crewAssignments        CrewAssignment[]
  complianceItems        ComplianceItem[]
  vesselDocuments        VesselDocument[]
  noonReports            NoonReport[]
  vesselHistory          VesselHistoryEntry[]
  timeChartersIn         TimeCharter[]                 @relation("TCVessel")
  positions              VesselPosition[]
  emissions              VesselEmission[]
  bunkerRfqs             BunkerRFQ[]
  geofenceAlerts         GeofenceAlert[]
  bunkerQuantityDisputes BunkerQuantityDispute[]
  certificates           VesselCertificate[]
  insurancePolicies      InsurancePolicy[]
  offHireEvents          OffHireEvent[]
  inspections            VesselInspection[]
  cashToMaster           CashToMaster[]
  beaufortLogs           BeaufortLog[]
  saleListings           SaleListing[]
  portAgentAppointments  PortAgentAppointment[]
  pdas                   ProformaDisbursementAccount[]
  congestionDetections   PortCongestionDetection[]
  congestionAlerts       PortCongestionAlert[]

  // Intelligent routing relations
  routes                 VesselRoute[]

  // Pre-arrival intelligence relations
  arrivals               VesselArrival[]       @relation("VesselArrivals")
  masterAlerts           MasterAlert[]         @relation("VesselMasterAlerts")
  daForecasts            DAForecastAccuracy[]  @relation("VesselDAForecasts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vessels")
}

model Port {
  id        String  @id @default(cuid())
  unlocode  String  @unique // UN/LOCODE (e.g., INMUN, SGSIN)
  name      String
  country   String // ISO 3166-1 alpha-2
  latitude  Float?
  longitude Float?
  timezone  String? // IANA timezone
  type      String  @default("seaport") // seaport, river_port, dry_port, anchorage

  // OpenSeaMap coverage tracking
  hasOpenSeaMap          Boolean   @default(false) // Quick flag for ANY OpenSeaMap data
  openSeaMapFeatureCount Int       @default(0) // Total count of seamark features
  openSeaMapCoverage     Json? // Detailed coverage: {hasBerths, hasAnchorages, hasHarbor, hasTerminals, hasNavAids}
  openSeaMapCheckedAt    DateTime? // Last time coverage was checked

  voyageDepartures     Voyage[]                  @relation("DeparturePort")
  voyageArrivals       Voyage[]                  @relation("ArrivalPort")
  milestones           VoyageMilestone[]
  disbursementAccounts DisbursementAccount[]
  terminals            Terminal[]
  tariffs              PortTariff[]
  holidays             PortHoliday[]
  enquiriesLoad        CargoEnquiry[]            @relation("EnquiryLoadPort")
  enquiriesDischarge   CargoEnquiry[]            @relation("EnquiryDischargePort")
  anchorages           Anchorage[]
  portWorkingHours     PortWorkingHours[]
  documentRequirements PortDocumentRequirement[]
  congestion           PortCongestion[]
  congestionZones      PortCongestionZone[]
  congestionDetections PortCongestionDetection[]
  congestionSnapshots  PortCongestionSnapshot[]
  congestionAlerts     PortCongestionAlert[]
  laytimeCalculations  LaytimeCalculation[]
  portCalls            VoyagePortCall[]
  restrictions         PortRestriction[]
  bunkerRfqs           BunkerRFQ[]               @relation("BunkerPort")
  reviewTasks          TariffReviewTask[]
  tariffDocuments      PortTariffDocument[]

  // Intelligent routing relations
  routesAsOrigin       VesselRoute[]             @relation("RouteOriginPort")
  routesAsDestination  VesselRoute[]             @relation("RouteDestPort")
  learnedPatternsOrigin LearnedRoutePattern[]    @relation("LearnedPatternOrigin")
  learnedPatternsDest   LearnedRoutePattern[]    @relation("LearnedPatternDest")

  // Pre-arrival intelligence relations
  arrivals             VesselArrival[]           @relation("PortArrivals")
  daForecasts          DAForecastAccuracy[]      @relation("PortDAForecasts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hasOpenSeaMap])
  @@index([openSeaMapFeatureCount])
  @@map("ports")
}

model Company {
  id             String  @id @default(cuid())
  name           String
  type           String // charterer, owner, broker, agent, cha, bunker_supplier, stevedore
  country        String?
  city           String?
  address        String?
  contactEmail   String?
  contactPhone   String?
  organizationId String

  organization           Organization                   @relation(fields: [organizationId], references: [id])
  chartersAsCharterer    Charter[]                      @relation("Charterer")
  chartersAsBroker       Charter[]                      @relation("Broker")
  vendorRatings          VendorRating[]
  contacts               Contact[]
  relationshipsA         CompanyRelationship[]          @relation("CompanyA")
  relationshipsB         CompanyRelationship[]          @relation("CompanyB")
  kycRecords             KYCRecord[]
  preferredVendorEntries PreferredVendor[]
  blacklistEntries       VendorBlacklist[]
  pdaLineItems           ProformaDisbursementLineItem[] @relation("PDALineItemVendor")
  fdaLineItems           FinalDisbursementLineItem[]    @relation("FDALineItemVendor")
  portVendorQuotes       PortVendorQuote[]              @relation("PortVendorQuote")
  portServices           PortServiceMaster[]            @relation("PortServiceVendor")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("companies")
}

model Cargo {
  id          String  @id @default(cuid())
  commodity   String // e.g., "Iron Ore Fines", "Wheat", "Crude Oil"
  hsCode      String? // Harmonized System code
  quantity    Float // In MT (metric tonnes)
  packaging   String  @default("bulk") // bulk, bagged, containerized, liquid
  description String?

  charterParties CharterParty[]
  voyages        Voyage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cargoes")
}

// === Chartering ===

model Charter {
  id             String    @id @default(cuid())
  reference      String    @unique // Internal reference number
  type           String // voyage, time, bareboat, coa
  status         String    @default("draft") // draft, on_subs, fixed, executed, completed, cancelled
  vesselId       String?
  chartererId    String?
  brokerId       String?
  organizationId String
  laycanStart    DateTime? // Laydays cancelling start
  laycanEnd      DateTime? // Laydays cancelling end
  fixtureDate    DateTime?
  freightRate    Float?
  freightUnit    String? // per_mt, lumpsum, daily
  currency       String    @default("USD")
  notes          String?

  vessel       Vessel?                  @relation(fields: [vesselId], references: [id])
  charterer    Company?                 @relation("Charterer", fields: [chartererId], references: [id])
  broker       Company?                 @relation("Broker", fields: [brokerId], references: [id])
  organization Organization             @relation(fields: [organizationId], references: [id])
  charterParty CharterParty?
  voyages      Voyage[]
  timeCharter  TimeCharter?
  subjects     FixtureSubject[]
  coa          ContractOfAffreightment?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("charters")
}

model CharterParty {
  id            String  @id @default(cuid())
  charterId     String  @unique
  formType      String? // GENCON, ASBATANKVOY, BALTIME, SHELLVOY, etc.
  content       String? // Full C/P text (markdown or structured)
  cargoId       String?
  loadPort      String?
  dischargePort String?

  charter  Charter                @relation(fields: [charterId], references: [id])
  cargo    Cargo?                 @relation(fields: [cargoId], references: [id])
  clauses  CharterPartyClauses[]
  addenda  CharterPartyAddendum[]
  versions CharterPartyVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("charter_parties")
}

model Clause {
  id       String  @id @default(cuid())
  code     String  @unique // e.g., "BIMCO-WAR", "GENCON-CL42"
  title    String
  body     String // Clause text
  category String // demurrage, laytime, insurance, war, ice, piracy, etc.
  source   String? // BIMCO, P&I, custom

  charterPartyClauses CharterPartyClauses[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("clauses")
}

model CharterPartyClauses {
  id             String  @id @default(cuid())
  charterPartyId String
  clauseId       String
  orderIndex     Int     @default(0)
  amendments     String? // Any amendments to standard clause

  charterParty CharterParty @relation(fields: [charterPartyId], references: [id])
  clause       Clause       @relation(fields: [clauseId], references: [id])

  @@unique([charterPartyId, clauseId])
  @@map("charter_party_clauses")
}

// === Voyage ===

model Voyage {
  id              String    @id @default(cuid())
  voyageNumber    String    @unique
  vesselId        String
  charterId       String?
  cargoId         String?
  departurePortId String?
  arrivalPortId   String?
  status          String    @default("planned") // planned, in_progress, completed, cancelled
  etd             DateTime? // Estimated time of departure
  eta             DateTime? // Estimated time of arrival
  atd             DateTime? // Actual time of departure
  ata             DateTime? // Actual time of arrival

  vessel               Vessel                @relation(fields: [vesselId], references: [id])
  charter              Charter?              @relation(fields: [charterId], references: [id])
  cargo                Cargo?                @relation(fields: [cargoId], references: [id])
  departurePort        Port?                 @relation("DeparturePort", fields: [departurePortId], references: [id])
  arrivalPort          Port?                 @relation("ArrivalPort", fields: [arrivalPortId], references: [id])
  milestones           VoyageMilestone[]
  disbursementAccounts DisbursementAccount[]
  laytimeCalculations  LaytimeCalculation[]
  billsOfLading        BillOfLading[]
  claims               Claim[]
  bunkerStems          BunkerStem[]
  bunkerROBs           BunkerROB[]
  crewAssignments      CrewAssignment[]
  noonReports          NoonReport[]
  cargoQuantityLogs    CargoQuantityLog[]
  nominations          Nomination[]
  portCalls            VoyagePortCall[]
  coaNominations       COANomination[]
  delayAlerts          DelayAlert[]
  cashToMaster         CashToMaster[]
  criticalPath         CriticalPathItem[]
  beaufortLogs         BeaufortLog[]
  lettersOfCredit      LetterOfCredit[]
  tradePayments        TradePayment[]

  // Intelligent routing relations
  routeQualityLogs     RouteQualityLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("voyages")
}

model VoyageMilestone {
  id       String    @id @default(cuid())
  voyageId String
  portId   String?
  type     String // departure, arrival, nor_tendered, berthed, loading_commenced,
  // loading_completed, discharge_commenced, discharge_completed, sailed
  planned  DateTime?
  actual   DateTime?
  notes    String?

  voyage Voyage @relation(fields: [voyageId], references: [id])
  port   Port?  @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("voyage_milestones")
}

// === DA Desk ===

model DisbursementAccount {
  id                String    @id @default(cuid())
  voyageId          String
  portId            String
  type              String    @default("pda") // pda (proforma), fda (final)
  status            String    @default("draft") // draft, submitted, approved, disputed, settled
  currency          String    @default("USD")
  totalAmount       Float     @default(0)
  notes             String?
  // Version control & funding
  version           Int       @default(1)
  parentId          String? // previous version's ID for comparison
  fundingStatus     String    @default("not_requested") // not_requested, requested, funded, settled
  fundingAmount     Float?
  fundedAt          DateTime?
  varianceThreshold Float     @default(10) // auto-approve FDA if variance < this % vs PDA

  voyage           Voyage            @relation(fields: [voyageId], references: [id])
  port             Port              @relation(fields: [portId], references: [id])
  lineItems        DaLineItem[]
  creditDebitNotes CreditDebitNote[]
  disputes         FdaDispute[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("disbursement_accounts")
}

model DaLineItem {
  id                    String  @id @default(cuid())
  disbursementAccountId String
  category              String // port_dues, pilotage, towage, berth_hire, agency_fee, etc.
  description           String
  amount                Float
  currency              String  @default("USD")
  tariffReference       String? // Reference to official tariff
  notes                 String?

  disbursementAccount DisbursementAccount @relation(fields: [disbursementAccountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("da_line_items")
}

// === Laytime ===

model LaytimeCalculation {
  id            String    @id @default(cuid())
  voyageId      String
  portId        String?
  type          String    @default("loading") // loading, discharging
  allowedHours  Float     @default(0) // Total allowed laytime in hours
  usedHours     Float     @default(0) // Actually used laytime in hours
  demurrageRate Float? // Per day rate
  despatchRate  Float? // Per day rate (usually 50% of demurrage)
  currency      String    @default("USD")
  result        String    @default("pending") // pending, on_demurrage, on_despatch, within_laytime
  amountDue     Float     @default(0) // Calculated amount (+ = demurrage, - = despatch)
  norTendered   DateTime? // Notice of Readiness
  norAccepted   DateTime?
  commencedAt   DateTime?
  completedAt   DateTime?
  notes         String?

  // Laytime rules engine
  commencementRule     String    @default("wibon") // wibon, wipon, wifpon, wccon
  exceptionRule        String    @default("shinc") // shinc, shex, fhex, eiu, uu
  reversible           Boolean   @default(false) // reversible laytime (combine load/discharge)
  shiftingTimeIncluded Boolean   @default(false) // whether shifting time counts
  noticeTimeHours      Float     @default(6) // hours after NOR before laytime commences
  timeBarDate          DateTime? // deadline for demurrage claim
  timeBarDays          Int       @default(90) // days after completion for time bar
  excludedHours        Float     @default(0) // hours excluded by rules (holidays, SHEX, etc.)
  grossHours           Float     @default(0) // total elapsed hours before exclusions

  voyage  Voyage                 @relation(fields: [voyageId], references: [id])
  port    Port?                  @relation(fields: [portId], references: [id])
  entries StatementOfFactEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("laytime_calculations")
}

model StatementOfFactEntry {
  id                   String    @id @default(cuid())
  laytimeCalculationId String
  eventType            String // nor_tendered, nor_accepted, berthed, commenced_loading,
  // completed_loading, commenced_discharge, completed_discharge,
  // hatch_open, hatch_closed, rain_start, rain_stop, holiday,
  // customs_hold, equipment_breakdown, shift_change
  eventTime            DateTime
  timeUsed             Float     @default(0) // hours counted toward laytime (can be 0 for excluded events)
  excluded             Boolean   @default(false) // Whether this time is excluded from laytime
  excludeReason        String? // rain, holiday, equipment_breakdown, etc.
  remarks              String?
  // Attachments
  attachmentUrl        String?
  attachmentType       String? // photo, document, email
  // Multi-party sign-off
  vesselSignOff        Boolean   @default(false)
  vesselSignedBy       String?
  vesselSignedAt       DateTime?
  agentSignOff         Boolean   @default(false)
  agentSignedBy        String?
  agentSignedAt        DateTime?
  terminalSignOff      Boolean   @default(false)
  terminalSignedBy     String?
  terminalSignedAt     DateTime?
  disputed             Boolean   @default(false)
  disputeNotes         String?

  laytimeCalculation LaytimeCalculation @relation(fields: [laytimeCalculationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@map("statement_of_fact_entries")
}

// === Vendor ===

model VendorRating {
  id        String  @id @default(cuid())
  companyId String
  userId    String // Rated by
  rating    Int // 1-5
  category  String // reliability, cost, communication, speed
  comment   String?

  company Company @relation(fields: [companyId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vendor_ratings")
}

// === Bill of Lading ===

model BillOfLading {
  id                String    @id @default(cuid())
  bolNumber         String    @unique
  type              String    @default("master") // master (MBL), house (HBL), electronic (eBL)
  voyageId          String
  cargoId           String?
  shipperId         String? // Company ID
  consigneeId       String? // Company ID
  notifyPartyId     String? // Company ID
  portOfLoading     String?
  portOfDischarge   String?
  placeOfReceipt    String?
  placeOfDelivery   String?
  status            String    @default("draft") // draft, issued, shipped, surrendered, accomplished, switch
  freightTerms      String    @default("prepaid") // prepaid, collect
  numberOfOriginals Int       @default(3)
  description       String?
  grossWeight       Float?
  measurement       Float? // CBM
  issuedAt          DateTime?
  issuedBy          String?

  voyage         Voyage             @relation(fields: [voyageId], references: [id])
  titleTransfers EblTitleTransfer[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voyageId])
  @@map("bills_of_lading")
}

// === eBL Title Chain (DCSA v3.0) ===

model EblTitleTransfer {
  id           String  @id @default(cuid())
  bolId        String
  fromParty    String // Company name or ID
  toParty      String // Company name or ID
  transferType String // issuance, endorsement, amendment, surrender, switch_to_paper
  dcsaStatus   String  @default("pending") // pending, requested, confirmed, rejected
  platformRef  String? // Platform transaction reference
  hash         String? // Document hash for integrity
  notes        String?
  initiatedBy  String?

  bol BillOfLading @relation(fields: [bolId], references: [id])

  createdAt DateTime @default(now())

  @@index([bolId])
  @@map("ebl_title_transfers")
}

// === Activity Log ===

model ActivityLog {
  id         String   @id @default(cuid())
  userId     String?
  userName   String?
  action     String // created, updated, transitioned, deleted, approved, submitted
  entityType String // charter, voyage, vessel, company, da, laytime, bol
  entityId   String
  details    String? // JSON string with change details
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("activity_logs")
}

// === Bunker Management ===

model BunkerStem {
  id           String    @id @default(cuid())
  voyageId     String
  portId       String?
  fuelType     String // ifo380, ifo180, vlsfo, mgo, lsmgo
  quantity     Float // MT ordered
  delivered    Float? // MT actually delivered
  pricePerMt   Float // USD per MT
  supplier     String?
  status       String    @default("ordered") // ordered, confirmed, delivered, invoiced, settled
  stemDate     DateTime?
  deliveryDate DateTime?
  notes        String?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voyageId])
  @@map("bunker_stems")
}

model BunkerROB {
  id         String   @id @default(cuid())
  voyageId   String
  fuelType   String // ifo380, ifo180, vlsfo, mgo, lsmgo
  quantity   Float // MT remaining
  reportDate DateTime
  location   String? // at_sea, port_name
  notes      String?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())

  @@index([voyageId, reportDate])
  @@map("bunker_rob")
}

// === Claims ===

model Claim {
  id                 String    @id @default(cuid())
  claimNumber        String    @unique
  voyageId           String
  type               String // cargo_damage, cargo_shortage, demurrage, dead_freight, deviation, general_average
  status             String    @default("open") // open, under_investigation, negotiation, settled, rejected, arbitration, closed
  claimantId         String? // Company ID
  respondentId       String? // Company ID
  amount             Float     @default(0)
  currency           String    @default("USD")
  settledAmount      Float?
  description        String?
  filedDate          DateTime  @default(now())
  settledDate        DateTime?
  dueDate            DateTime?
  priority           String    @default("medium") // low, medium, high, critical
  notes              String?
  // Time bar tracking
  timeBarDate        DateTime? // statute expiry (typically 1 year from event)
  timeBarStatus      String    @default("active") // active, warning, expired, extended
  // Counter-claims
  counterClaimId     String? // linked counter-claim
  // Claim package
  packageAssembled   Boolean   @default(false)
  packageAssembledAt DateTime?

  voyage        Voyage          @relation(fields: [voyageId], references: [id])
  documents     ClaimDocument[]
  evidence      ClaimEvidence[]
  claimPackages ClaimPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voyageId])
  @@index([status])
  @@index([timeBarDate])
  @@map("claims")
}

model ClaimDocument {
  id      String  @id @default(cuid())
  claimId String
  name    String
  type    String // survey_report, notice_of_claim, correspondence, photo, settlement_agreement, arbitration_award
  url     String?
  notes   String?

  claim Claim @relation(fields: [claimId], references: [id])

  createdAt DateTime @default(now())

  @@map("claim_documents")
}

// === Notifications ===

model Notification {
  id         String   @id @default(cuid())
  userId     String? // null = broadcast to all
  type       String // charter_status, voyage_departure, voyage_arrival, da_submitted, laytime_alert, system
  title      String
  message    String
  entityType String? // charter, voyage, da, laytime
  entityId   String?
  read       Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([userId, read])
  @@map("notifications")
}

// === Crew Management ===

model CrewMember {
  id             String    @id @default(cuid())
  firstName      String
  lastName       String
  rank           String // master, chief_officer, second_officer, chief_engineer, ab_seaman, etc.
  nationality    String // ISO country code
  cdcNumber      String? // Continuous Discharge Certificate
  passportNumber String?
  passportExpiry DateTime?
  seamanBookNo   String?
  dateOfBirth    DateTime?
  phone          String?
  email          String?
  status         String    @default("available") // available, on_board, on_leave, medical, terminated
  organizationId String

  assignments  CrewAssignment[]
  certificates CrewCertificate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("crew_members")
}

model CrewAssignment {
  id           String    @id @default(cuid())
  crewMemberId String
  vesselId     String
  voyageId     String?
  rank         String // rank on this assignment
  signOnDate   DateTime
  signOffDate  DateTime?
  status       String    @default("active") // active, completed, early_relief

  crewMember CrewMember @relation(fields: [crewMemberId], references: [id])
  vessel     Vessel     @relation(fields: [vesselId], references: [id])
  voyage     Voyage?    @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())

  @@map("crew_assignments")
}

model CrewCertificate {
  id           String    @id @default(cuid())
  crewMemberId String
  name         String // STCW, GMDSS, Medical, etc.
  issueDate    DateTime?
  expiryDate   DateTime?
  issuingAuth  String? // DG Shipping, MCA, etc.
  certNumber   String?
  status       String    @default("valid") // valid, expired, suspended

  crewMember CrewMember @relation(fields: [crewMemberId], references: [id])

  createdAt DateTime @default(now())

  @@map("crew_certificates")
}

// === Document Vault ===

model Document {
  id             String   @id @default(cuid())
  title          String
  category       String // charter_party, bol, correspondence, survey, insurance, certificate, invoice, report
  subcategory    String?
  fileName       String
  fileSize       Int      @default(0)
  mimeType       String   @default("application/pdf")
  entityType     String? // vessel, voyage, charter, company
  entityId       String?
  voyageId       String?
  vesselId       String?
  uploadedBy     String?
  tags           String[] @default([])
  notes          String?
  organizationId String
  status         String   @default("active") // active, archived, deleted

  // Phase 33: Analytics & Advanced Features
  viewCount        Int       @default(0)
  downloadCount    Int       @default(0)
  lastViewedAt     DateTime?
  lastDownloadedAt DateTime?
  filePath         String? // MinIO object key
  fileHash         String? // SHA-256 hash
  deletedAt        DateTime?
  folderId         String? // Document folder
  metadata         Json? // Additional metadata

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions DocumentVersion[]

  @@index([organizationId, category])
  @@index([entityType, entityId])
  @@map("documents")
}

// === Phase 33: Document Analytics ===

model DocumentAnalytics {
  id         String   @id @default(cuid())
  documentId String
  eventType  String // view, download, share, edit
  userId     String?
  ipAddress  String?
  metadata   Json?
  timestamp  DateTime @default(now())

  @@index([documentId, timestamp])
  @@map("document_analytics")
}

// === Phase 32: RAG & Knowledge Engine ===

model MaritimeDocument {
  id         String                       @id @default(cuid())
  documentId String // Links to Document.id
  title      String
  content    String                       @db.Text
  section    String?
  chunkIndex Int                          @default(0)
  docType    String // charter_party, bol, email, market_report, compliance
  embedding  Unsupported("vector(1536)")? // Voyage AI voyage-code-2 dimension

  // Maritime-specific metadata
  vesselId  String?
  voyageId  String?
  charterId String?
  companyId String?

  // Entity extraction
  vesselNames String[] @default([])
  portNames   String[] @default([])
  cargoTypes  String[] @default([])
  parties     String[] @default([])

  // Search metadata
  tags       String[]                 @default([])
  importance Float                    @default(0.5)
  contentTsv Unsupported("tsvector")?

  // Multi-tenancy
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, docType])
  @@index([documentId])
  @@index([vesselId])
  @@index([voyageId])
  @@map("maritime_documents")
}

model SearchQuery {
  id             String   @id @default(cuid())
  userId         String?
  organizationId String
  query          String
  queryType      String   @default("semantic")
  resultsCount   Int      @default(0)
  responseTime   Int
  createdAt      DateTime @default(now())

  @@index([organizationId, createdAt])
  @@map("search_queries")
}

// PageIndex tree storage for charter parties and long documents
model DocumentIndex {
  id         String   @id @default(cuid())
  documentId String   @unique
  indexType  String   @default("pageindex_tree")
  indexData  Json // PageIndex tree structure
  version    String   @default("1.0")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([documentId])
  @@map("document_index")
}

model DocumentProcessingJob {
  id            String    @id @default(cuid())
  documentId    String
  status        String    @default("pending")
  jobType       String // chunking, embedding, entity_extraction
  progress      Float     @default(0)
  chunksCreated Int       @default(0)
  error         String?
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime  @default(now())

  @@index([status, jobType])
  @@map("document_processing_jobs")
}

// === Phase 33: Advanced Document Management System ===

model DocumentVersion {
  id             String  @id @default(cuid())
  documentId     String // Links to Document.id
  versionNumber  Int
  fileHash       String // SHA-256 hash of file content
  fileSize       Int
  mimeType       String
  storagePath    String? // MinIO/S3 path
  changelog      String? // What changed in this version
  uploadedBy     String
  uploadedByName String?
  organizationId String

  createdAt DateTime @default(now())
  document  Document @relation(fields: [documentId], references: [id])

  @@unique([documentId, versionNumber])
  @@index([documentId])
  @@index([organizationId])
  @@map("document_versions")
}

model DocumentFolder {
  id             String   @id @default(cuid())
  name           String
  parentId       String? // Self-reference for nested folders
  folderPath     String // Full path like /vessels/mv-ocean/certificates
  folderType     String // vessel, voyage, company, type
  entityId       String? // vesselId, voyageId, companyId if applicable
  description    String?
  permissions    String[] @default([]) // userId array with access
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([organizationId, folderPath])
  @@index([organizationId, folderType])
  @@index([parentId])
  @@map("document_folders")
}

model DocumentLock {
  id              String    @id @default(cuid())
  documentId      String    @unique // Only one lock per document
  lockedBy        String
  lockedByName    String?
  lockReason      String? // "Editing", "Review", "Approval", etc.
  expectedRelease DateTime?
  organizationId  String

  lockedAt DateTime @default(now())

  @@index([organizationId])
  @@index([lockedBy])
  @@map("document_locks")
}

model BlockchainProof {
  id                String  @id @default(cuid())
  documentId        String  @unique // One proof per document
  documentHash      String // SHA-256 hash of document
  blockchainTxId    String // Transaction ID on blockchain
  blockchainNetwork String  @default("polygon") // ethereum, polygon, etc.
  verificationUrl   String?
  proofType         String  @default("standard") // standard, ebl_dcsa, cp_immutable
  metadata          Json? // Additional blockchain metadata
  organizationId    String

  // DCSA eBL compliance fields
  eblNumber   String?
  eblStandard String? // "DCSA eBL 3.0"

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([documentHash])
  @@map("blockchain_proofs")
}

model CertificateExpiry {
  id              String    @id @default(cuid())
  documentId      String    @unique // One expiry tracking per certificate
  certificateType String // class_certificate, doc_smc, insurance, etc.
  issuedBy        String?
  issueDate       DateTime?
  expiryDate      DateTime
  renewalDue      DateTime? // Date to start renewal process
  vesselId        String?
  entityType      String? // vessel, company, crew
  entityId        String?
  alertSent30     Boolean   @default(false) // Alert sent 30 days before
  alertSent60     Boolean   @default(false) // Alert sent 60 days before
  alertSent90     Boolean   @default(false) // Alert sent 90 days before
  renewalStatus   String    @default("pending") // pending, in_progress, renewed, expired
  organizationId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, expiryDate])
  @@index([vesselId])
  @@index([renewalStatus])
  @@map("certificate_expiries")
}

model DocumentAuditLog {
  id              String  @id @default(cuid())
  documentId      String
  action          String // created, viewed, downloaded, edited, versioned, archived, deleted, locked, unlocked
  performedBy     String
  performedByName String?
  ipAddress       String?
  userAgent       String?
  changes         Json? // What changed (for edits)
  metadata        Json? // Additional context
  organizationId  String

  createdAt DateTime @default(now())

  @@index([documentId])
  @@index([organizationId, createdAt])
  @@index([performedBy])
  @@map("document_audit_logs")
}

// === Phase 33: Task #68 - Document Workflow Automation ===

model WorkflowTemplate {
  id             String   @id @default(cuid())
  name           String
  description    String?
  category       String // charter_party, invoice, certificate, etc.
  organizationId String
  steps          Json // Array of WorkflowStep objects
  autoStart      Boolean  @default(false)
  conditions     Json? // Array of WorkflowCondition objects
  isActive       Boolean  @default(true)
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  instances WorkflowInstance[]

  @@index([organizationId, category])
  @@index([autoStart])
  @@map("workflow_templates")
}

model WorkflowInstance {
  id                String    @id @default(cuid())
  documentId        String
  templateId        String
  organizationId    String
  status            String    @default("in_progress") // pending, in_progress, completed, cancelled, rejected
  currentStepNumber Int       @default(1)
  startedAt         DateTime  @default(now())
  completedAt       DateTime?
  initiatedBy       String
  steps             Json // Array of WorkflowStepInstance objects

  template WorkflowTemplate @relation(fields: [templateId], references: [id])

  @@index([documentId])
  @@index([organizationId, status])
  @@index([templateId])
  @@map("workflow_instances")
}

model RoutingRule {
  id             String   @id @default(cuid())
  name           String
  description    String?
  organizationId String
  priority       Int      @default(0) // Higher = evaluated first
  conditions     Json // Array of WorkflowCondition objects
  actions        Json // Array of RoutingAction objects
  enabled        Boolean  @default(true)
  createdBy      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId, enabled, priority])
  @@map("routing_rules")
}

model SavedSearch {
  id             String   @id @default(cuid())
  name           String
  filters        Json // AdvancedSearchFilters object
  organizationId String
  createdBy      String
  isPublic       Boolean  @default(false)
  usageCount     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([organizationId, createdBy])
  @@map("saved_searches")
}

model RetentionPolicy {
  id               String   @id @default(cuid())
  name             String
  category         String
  retentionDays    Int // How long to keep active
  archiveAfterDays Int // When to archive
  deleteAfterDays  Int // When to hard delete
  organizationId   String
  enabled          Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([organizationId, category, enabled])
  @@map("retention_policies")
}

// === Alert Preferences ===

model AlertPreference {
  id              String  @id @default(cuid())
  userId          String
  eventType       String // charter_status, voyage_departure, voyage_arrival, da_submitted, laytime_alert, claim_update, cert_expiry, bunker_delivery
  emailEnabled    Boolean @default(true)
  whatsappEnabled Boolean @default(false)
  pushEnabled     Boolean @default(true)
  phone           String? // WhatsApp number with country code

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, eventType])
  @@map("alert_preferences")
}

model AlertLog {
  id         String  @id @default(cuid())
  userId     String?
  eventType  String
  channel    String // email, whatsapp, push, in_app
  recipient  String // email address or phone number
  subject    String?
  message    String
  status     String  @default("sent") // sent, failed, pending
  entityType String?
  entityId   String?

  createdAt DateTime @default(now())

  @@index([userId, eventType])
  @@map("alert_logs")
}

// === ISM/ISPS Compliance ===

model ComplianceItem {
  id             String    @id @default(cuid())
  vesselId       String
  category       String // ism, isps, marpol, solas, stcw, port_state, flag_state, class
  title          String
  description    String?
  status         String    @default("compliant") // compliant, non_compliant, pending_review, expired, waiver
  dueDate        DateTime?
  completedDate  DateTime?
  inspector      String?
  findings       String?
  priority       String    @default("medium") // low, medium, high, critical
  organizationId String

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId, category])
  @@index([status])
  @@map("compliance_items")
}

// === Phase 2: Vessel Documents ===

model VesselDocument {
  id             String    @id @default(cuid())
  vesselId       String
  type           String // class_certificate, doc_smc, issc, iopp, insurance_hull, insurance_pi, solas, marpol, mlc, safety_radio, tonnage
  title          String
  issuedBy       String? // Classification society, P&I club, flag state
  issueDate      DateTime?
  expiryDate     DateTime?
  documentNumber String?
  status         String    @default("valid") // valid, expired, pending_renewal, suspended
  notes          String?
  organizationId String

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId, type])
  @@index([expiryDate])
  @@map("vessel_documents")
}

// === Phase 2: Terminal & Berth ===

model Terminal {
  id           String   @id @default(cuid())
  portId       String
  name         String
  operator     String?
  berthCount   Int      @default(0)
  cargoTypes   String[] @default([]) // dry_bulk, liquid_bulk, container, breakbulk, ro_ro
  maxDraft     Float? // meters
  maxLOA       Float? // meters
  maxBeam      Float? // meters
  workingHours String? // e.g., "24/7", "06:00-18:00"
  notes        String?

  port   Port    @relation(fields: [portId], references: [id])
  berths Berth[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portId])
  @@map("terminals")
}

model Berth {
  id         String   @id @default(cuid())
  terminalId String
  name       String
  length     Float? // meters
  depth      Float? // meters
  cargoTypes String[] @default([])
  craneSpecs String?
  status     String   @default("operational") // operational, under_maintenance, closed

  terminal Terminal @relation(fields: [terminalId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("berths")
}

// === Phase 2: Port Tariff & Holiday ===

model PortTariff {
  id            String    @id @default(cuid())
  portId        String
  vesselType    String? // bulk_carrier, tanker, container, general_cargo (null = all)
  sizeRangeMin  Float? // DWT min
  sizeRangeMax  Float? // DWT max
  chargeType    String // port_dues, pilotage, towage, berth_hire, anchorage, light_dues, mooring, unmooring, agency_fee, canal_dues
  amount        Float
  currency      String    @default("USD")
  unit          String    @default("per_grt") // per_grt, per_nrt, per_mt, lumpsum, per_hour, per_day
  effectiveFrom DateTime  @default(now())
  effectiveTo   DateTime?
  notes         String?

  // Data source tracking
  dataSource String    @default("SIMULATED") // REAL_SCRAPED, SIMULATED, API, MANUAL
  sourceUrl  String? // URL where data was scraped from
  scrapedAt  DateTime? // When it was scraped

  port Port @relation(fields: [portId], references: [id])

  createdAt                     DateTime                       @default(now())
  updatedAt                     DateTime                       @updatedAt
  proformaDisbursementLineItems ProformaDisbursementLineItem[]

  @@index([portId, chargeType])
  @@index([dataSource])
  @@map("port_tariffs")
}

model PortHoliday {
  id             String   @id @default(cuid())
  portId         String
  date           DateTime
  name           String
  affectsLaytime Boolean  @default(true)
  country        String?
  recurring      Boolean  @default(false) // annual recurring holiday

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())

  @@index([portId, date])
  @@map("port_holidays")
}

model CanalTransit {
  id              String   @id @default(cuid())
  canal           String // suez, panama, kiel, corinth, turkish_straits
  vesselType      String? // null = all types
  sizeRangeMin    Float? // DWT or SCNT min
  sizeRangeMax    Float? // DWT or SCNT max
  baseCost        Float
  currency        String   @default("USD")
  calculationRule String? // e.g., "SCNT-based", "PC/UMS-based"
  notes           String?
  effectiveFrom   DateTime @default(now())

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("canal_transits")
}

// === Phase 2: Contact & Company Relationship ===

model Contact {
  id          String  @id @default(cuid())
  companyId   String
  firstName   String
  lastName    String
  email       String?
  phone       String?
  mobile      String?
  role        String? // chartering, operations, finance, legal, management
  designation String? // Managing Director, Chartering Manager, Operations Executive
  isPrimary   Boolean @default(false)
  notes       String?

  company Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@map("contacts")
}

model CompanyRelationship {
  id         String  @id @default(cuid())
  companyAId String
  companyBId String
  type       String // broker_for, agent_of, subsidiary_of, parent_of, partner_with, insurer_of
  notes      String?

  companyA Company @relation("CompanyA", fields: [companyAId], references: [id])
  companyB Company @relation("CompanyB", fields: [companyBId], references: [id])

  createdAt DateTime @default(now())

  @@unique([companyAId, companyBId, type])
  @@map("company_relationships")
}

// === Phase 2: Cargo Enquiry ===

model CargoEnquiry {
  id              String    @id @default(cuid())
  reference       String    @unique
  chartererId     String? // Company ID
  brokerId        String? // Company ID
  cargoType       String // commodity name
  hsCode          String?
  quantity        Float // MT
  tolerance       Float? // % (e.g., 5.0 = 5%)
  packaging       String    @default("bulk")
  loadPortId      String?
  dischargePortId String?
  laycanFrom      DateTime?
  laycanTo        DateTime?
  rateIndication  Float?
  rateUnit        String? // per_mt, lumpsum, worldscale
  currency        String    @default("USD")
  status          String    @default("open") // open, working, covered, withdrawn, expired
  notes           String?
  organizationId  String
  receivedVia     String? // email, phone, whatsapp, platform
  receivedAt      DateTime  @default(now())

  loadPort      Port? @relation("EnquiryLoadPort", fields: [loadPortId], references: [id])
  dischargePort Port? @relation("EnquiryDischargePort", fields: [dischargePortId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([organizationId])
  @@map("cargo_enquiries")
}

// === Phase 2: Financial Models ===

model Invoice {
  id             String    @id @default(cuid())
  invoiceNumber  String    @unique
  type           String // freight, demurrage, hire, commission, pda, fda, bunker, agency_fee, survey
  voyageId       String?
  charterId      String?
  companyId      String? // bill-to company
  amount         Float
  currency       String    @default("USD")
  taxAmount      Float     @default(0)
  totalAmount    Float // amount + taxAmount
  status         String    @default("draft") // draft, issued, sent, partially_paid, paid, overdue, cancelled, credit_note
  issueDate      DateTime  @default(now())
  dueDate        DateTime?
  paidDate       DateTime?
  paidAmount     Float     @default(0)
  description    String?
  notes          String?
  organizationId String

  payments     Payment[]
  fdaLineItems FinalDisbursementLineItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, status])
  @@index([dueDate])
  @@map("invoices")
}

model Payment {
  id          String    @id @default(cuid())
  invoiceId   String
  amount      Float
  currency    String    @default("USD")
  method      String // swift, upi, cheque, wire, cash, neft, rtgs
  reference   String? // bank reference / transaction ID
  bankName    String?
  settledDate DateTime?
  status      String    @default("pending") // pending, confirmed, failed, reversed
  notes       String?

  invoice Invoice @relation(fields: [invoiceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([invoiceId])
  @@map("payments")
}

model Commission {
  id             String  @id @default(cuid())
  charterId      String?
  voyageId       String?
  partyId        String? // Company receiving commission
  type           String // address_commission, brokerage
  percentage     Float // e.g., 1.25, 2.5, 3.75
  baseAmount     Float   @default(0) // freight/hire amount commission is calculated on
  amount         Float   @default(0) // calculated commission amount
  currency       String  @default("USD")
  status         String  @default("pending") // pending, invoiced, paid
  invoiceId      String?
  notes          String?
  organizationId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([charterId])
  @@index([organizationId])
  @@map("commissions")
}

model CurrencyRate {
  id      String   @id @default(cuid())
  fromCcy String // USD, EUR, GBP, NOK, SGD, INR, JPY, CNY
  toCcy   String
  rate    Float
  date    DateTime
  source  String? // ecb, reuters, manual

  @@unique([fromCcy, toCcy, date])
  @@index([date])
  @@map("currency_rates")
}

// ==========================================
// Phase 2 remaining models
// ==========================================

model NoonReport {
  id               String   @id @default(cuid())
  vesselId         String
  voyageId         String?
  reportDate       DateTime
  reportType       String   @default("noon") // noon, departure, arrival, in_port
  // Position
  latitude         Float?
  longitude        Float?
  course           Float?
  // Speed & distance
  speedOrdered     Float?
  speedActual      Float?
  distanceSailed   Float? // nautical miles in last 24h
  distanceToGo     Float?
  // Consumption (MT per 24h)
  foConsumed       Float? // fuel oil
  doConsumed       Float? // diesel oil
  lsfoConsumed     Float? // low sulfur fuel oil
  mgoConsumed      Float? // marine gas oil
  // ROB (remaining on board)
  foROB            Float?
  doROB            Float?
  lsfoROB          Float?
  mgoROB           Float?
  fwROB            Float? // fresh water
  // Weather
  windForce        Int? // Beaufort scale 0-12
  windDirection    String? // N, NE, E, SE, S, SW, W, NW
  seaState         Int? // Douglas scale 0-9
  swellHeight      Float? // meters
  currentSpeed     Float? // knots
  currentDirection String?
  // Engine
  meRPM            Float? // main engine RPM
  mePower          Float? // kW
  slipPercentage   Float?
  // Remarks
  remarks          String?

  vessel Vessel  @relation(fields: [vesselId], references: [id])
  voyage Voyage? @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())

  @@index([vesselId, reportDate])
  @@index([voyageId])
  @@map("noon_reports")
}

model VesselHistoryEntry {
  id         String   @id @default(cuid())
  vesselId   String
  changeType String // name_change, flag_change, class_change, ownership_change, status_change
  changeDate DateTime
  fromValue  String?
  toValue    String?
  remarks    String?
  source     String? // manual, ais, registry

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())

  @@index([vesselId, changeDate])
  @@map("vessel_history")
}

model KYCRecord {
  id              String    @id @default(cuid())
  companyId       String
  status          String    @default("pending") // pending, verified, rejected, expired
  riskScore       Int? // 0-100
  // UBO
  uboName         String?
  uboNationality  String?
  uboPepCheck     Boolean   @default(false)
  // Sanctions
  sanctionsCheck  Boolean   @default(false)
  sanctionsResult String? // clear, flagged, blocked
  sanctionsDate   DateTime?
  // Documents
  registrationDoc String? // file reference
  taxId           String?
  maritimeLicense String?
  // Review
  reviewer        String?
  reviewNotes     String?
  lastChecked     DateTime?
  nextReview      DateTime?
  organizationId  String

  company Company @relation(fields: [companyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
  @@index([organizationId])
  @@map("kyc_records")
}

model CargoCompatibility {
  id         String  @id @default(cuid())
  cargoA     String
  cargoB     String
  compatible Boolean
  notes      String?
  source     String? // imo, imsbc, manual

  @@unique([cargoA, cargoB])
  @@map("cargo_compatibility")
}

// ==========================================
// Phase 3.6: Time Charter models
// ==========================================

model TimeCharter {
  id                 String    @id @default(cuid())
  reference          String    @unique
  direction          String // tc_in, tc_out
  charterId          String?   @unique
  vesselId           String
  chartererId        String? // who we charter from (tc_in) or to (tc_out)
  organizationId     String
  // Terms
  hireRate           Float // USD per day
  currency           String    @default("USD")
  deliveryDate       DateTime?
  deliveryPort       String?
  redeliveryDate     DateTime?
  redeliveryPort     String?
  minDuration        Int? // months
  maxDuration        Int? // months
  // Notices
  redeliveryNotice   Int? // days notice required
  // Speed & consumption warranty
  balSpeed           Float? // knots ballast
  ladenSpeed         Float? // knots laden
  balConsumption     Float? // MT/day ballast
  ladenConsumption   Float? // MT/day laden
  // Bunker
  bunkerDeliveryFO   Float? // MT at delivery
  bunkerDeliveryDO   Float?
  bunkerPriceAtDel   Float? // price per MT at delivery
  bunkerRedeliveryFO Float?
  bunkerRedeliveryDO Float?
  // Status
  status             String    @default("pending") // pending, active, redelivered, terminated
  notes              String?

  charter              Charter?              @relation(fields: [charterId], references: [id])
  vessel               Vessel                @relation("TCVessel", fields: [vesselId], references: [id])
  hirePayments         HirePayment[]
  offHires             OffHire[]
  hirePaymentSchedules HirePaymentSchedule[]
  offHireEvents        OffHireEvent[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
  @@index([status])
  @@index([organizationId])
  @@map("time_charters")
}

model HirePayment {
  id            String    @id @default(cuid())
  timeCharterId String
  periodFrom    DateTime
  periodTo      DateTime
  hireRate      Float
  totalDays     Float
  grossAmount   Float
  deductions    Float     @default(0) // off-hire, bunker adj, etc.
  netAmount     Float
  currency      String    @default("USD")
  status        String    @default("pending") // pending, invoiced, paid, disputed
  dueDate       DateTime?
  paidDate      DateTime?
  reference     String?
  notes         String?

  timeCharter TimeCharter @relation(fields: [timeCharterId], references: [id])

  createdAt DateTime @default(now())

  @@index([timeCharterId])
  @@index([status])
  @@map("hire_payments")
}

model OffHire {
  id              String    @id @default(cuid())
  timeCharterId   String
  offHireFrom     DateTime
  offHireTo       DateTime?
  reason          String // breakdown, drydock, deviation, detention, strike, other
  clause          String? // reference to C/P clause
  totalHours      Float?
  hireRate        Float?
  deductionAmount Float?
  currency        String    @default("USD")
  status          String    @default("claimed") // claimed, agreed, disputed, settled
  notes           String?

  timeCharter TimeCharter @relation(fields: [timeCharterId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timeCharterId])
  @@map("off_hires")
}

// === Vessel Position ===

/// VesselPosition - TimescaleDB hypertable (7-day chunks, 30-day compression, 2-year retention)
/// GiST geospatial index on PostGIS 'location' geography column (created via migration)
model VesselPosition {
  id          String    @id @default(cuid())
  vesselId    String
  latitude    Float
  longitude   Float
  speed       Float? // knots (SOG - Speed Over Ground)
  heading     Float? // degrees 0-360 (True Heading)
  course      Float? // COG degrees (Course Over Ground)
  status      String? // underway, at_anchor, moored, aground, not_under_command
  destination String?
  eta         DateTime?
  source      String    @default("manual") // manual, ais_terrestrial, ais_satellite, spire
  timestamp   DateTime  @default(now())

  // Priority 1: Navigation dynamics (AIS Message Type 1/2/3)
  rateOfTurn          Float?   // degrees per minute (-720 to +720, -128 means not available)
  navigationStatus    Int?     // 0-15 AIS navigation status code (0=underway engine, 1=anchor, 5=moored, etc)
  positionAccuracy    Boolean? // true = DGPS quality (< 10m), false = unaugmented GNSS (> 10m)
  maneuverIndicator   Int?     // 0=not available, 1=no special maneuver, 2=special maneuver
  raimFlag            Boolean? // Receiver Autonomous Integrity Monitoring flag
  timestampSeconds    Int?     // UTC second when report was generated (0-59, 60=not available)

  // Priority 1: Vessel characteristics (AIS Message Type 5)
  draught             Float?   // Current draught in meters (0.1m resolution, 25.5=not available)
  dimensionToBow      Int?     // Distance from AIS unit to bow in meters
  dimensionToStern    Int?     // Distance from AIS unit to stern in meters
  dimensionToPort     Int?     // Distance from AIS unit to port side in meters
  dimensionToStarboard Int?    // Distance from AIS unit to starboard in meters

  vessel Vessel @relation(fields: [vesselId], references: [id])

  @@index([vesselId])
  @@index([timestamp])
  @@index([vesselId, timestamp])
  @@index([navigationStatus]) // For fleet status queries
  @@index([draught]) // For port compatibility queries
  @@map("vessel_positions")
}

// === Port Congestion ===

/// PortCongestion - TimescaleDB hypertable (7-day chunks, 30-day compression, 1-year retention)
model PortCongestion {
  id               String   @id @default(cuid())
  portId           String
  vesselsWaiting   Int      @default(0)
  vesselsAtBerth   Int      @default(0)
  avgWaitHours     Float?
  berthUtilization Float? // 0-100 percentage
  cargoType        String? // dry_bulk, liquid_bulk, container, etc.
  source           String   @default("manual") // manual, ais_derived, port_authority
  notes            String?
  timestamp        DateTime @default(now())

  port Port @relation(fields: [portId], references: [id])

  @@index([portId])
  @@index([timestamp])
  @@index([portId, timestamp])
  @@map("port_congestion")
}

// === Port Congestion Monitoring System (Advanced) ===

model PortCongestionZone {
  id             String   @id @default(cuid())
  portId         String
  zoneType       String // 'ANCHORAGE', 'BERTH', 'WAITING_AREA', 'APPROACH'
  zoneName       String
  boundaryGeoJson Json // { type: 'Polygon', coordinates: [...] }

  // Capacity limits
  normalCapacity   Int
  highCapacity     Int
  criticalCapacity Int

  // Metadata
  isActive   Boolean  @default(true)
  priority   Int      @default(5) // 1-10 (10 = highest)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  port        Port                       @relation(fields: [portId], references: [id], onDelete: Cascade)
  detections  PortCongestionDetection[]
  snapshots   PortCongestionSnapshot[]
  alerts      PortCongestionAlert[]

  @@index([portId, zoneType])
  @@index([isActive])
  @@map("port_congestion_zones")
}

model PortCongestionDetection {
  id                   String    @id @default(cuid())
  vesselId             String
  portId               String
  zoneId               String?
  detectedAt           DateTime  @default(now())
  navigationStatus     String // From AIS: 'AT_ANCHOR', 'MOORED', etc.

  // Position snapshot
  latitude  Float
  longitude Float

  // Wait time tracking
  arrivalTime   DateTime
  departureTime DateTime?
  waitTimeHours Float?

  // Congestion metrics
  vesselCountAtArrival    Int
  congestionLevel         String // 'NORMAL', 'MODERATE', 'HIGH', 'CRITICAL'
  estimatedDetentionCost  Float?

  // Status
  isActive Boolean @default(true) // false when vessel departs

  // Relations
  vessel Vessel                   @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  port   Port                     @relation(fields: [portId], references: [id], onDelete: Cascade)
  zone   PortCongestionZone?      @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  @@index([vesselId, isActive])
  @@index([portId, isActive])
  @@index([zoneId, isActive])
  @@index([detectedAt])
  @@index([congestionLevel])
  @@map("port_congestion_detections")
}

model PortCongestionSnapshot {
  id        String   @id @default(cuid())
  portId    String
  zoneId    String?
  timestamp DateTime @default(now())

  // Metrics
  vesselCount    Int
  anchoredCount  Int
  mooredCount    Int

  // Vessel type breakdown
  cargoCount        Int
  tankerCount       Int
  containerCount    Int
  bulkCarrierCount  Int

  // Wait time statistics
  avgWaitTimeHours    Float?
  maxWaitTimeHours    Float?
  medianWaitTimeHours Float?

  // Congestion level
  congestionLevel String // 'NORMAL', 'MODERATE', 'HIGH', 'CRITICAL'
  capacityPercent Float // vesselCount / normalCapacity * 100

  // Trend indicators
  trend         String // 'IMPROVING', 'STABLE', 'WORSENING'
  changePercent Float?

  // Relations
  port Port                   @relation(fields: [portId], references: [id], onDelete: Cascade)
  zone PortCongestionZone?    @relation(fields: [zoneId], references: [id], onDelete: SetNull)

  @@unique([portId, zoneId, timestamp])
  @@index([portId, timestamp])
  @@index([zoneId, timestamp])
  @@index([congestionLevel])
  @@map("port_congestion_snapshots")
}

model PortCongestionAlert {
  id           String    @id @default(cuid())
  portId       String
  zoneId       String?
  vesselId     String?
  alertType    String // 'CONGESTION_HIGH', 'WAIT_TIME_EXCEEDED', 'CAPACITY_CRITICAL'
  severity     String // 'INFO', 'WARNING', 'CRITICAL'
  title        String
  message      String

  // Trigger conditions
  triggeredAt  DateTime  @default(now())
  triggerValue Float?
  threshold    Float?

  // Notification status
  status          String    @default("ACTIVE") // 'ACTIVE', 'ACKNOWLEDGED', 'RESOLVED', 'DISMISSED'
  acknowledgedAt  DateTime?
  acknowledgedBy  String?
  resolvedAt      DateTime?

  // Delivery tracking
  emailSent   Boolean @default(false)
  smsSent     Boolean @default(false)
  webhookSent Boolean @default(false)

  // Relations
  port   Port                 @relation(fields: [portId], references: [id], onDelete: Cascade)
  zone   PortCongestionZone?  @relation(fields: [zoneId], references: [id], onDelete: SetNull)
  vessel Vessel?              @relation(fields: [vesselId], references: [id], onDelete: SetNull)

  @@index([portId, status])
  @@index([severity, status])
  @@index([triggeredAt])
  @@map("port_congestion_alerts")
}

// === Port Intelligence: Anchorage ===

model Anchorage {
  id            String  @id @default(cuid())
  portId        String
  name          String
  latitude      Float?
  longitude     Float?
  depth         Float? // meters
  holdingGround String? // good, moderate, poor
  maxVessels    Int?
  shelter       String? // good, moderate, exposed
  cargoOps      Boolean @default(false) // STS operations allowed
  notes         String?

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portId])
  @@map("anchorages")
}

// === Port Intelligence: Working Hours ===

model PortWorkingHours {
  id         String   @id @default(cuid())
  portId     String
  dayOfWeek  Int // 0=Sunday, 1=Monday ... 6=Saturday
  shiftName  String // day_shift, night_shift, 24h
  startTime  String // HH:MM format
  endTime    String // HH:MM format
  cargoTypes String[] @default([]) // which cargo types this applies to
  notes      String?

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())

  @@index([portId])
  @@map("port_working_hours")
}

// === Port Intelligence: Document Requirements ===

model PortDocumentRequirement {
  id           String  @id @default(cuid())
  portId       String
  country      String // ISO alpha-2
  documentName String // e.g., "Crew List", "Ship Sanitation Certificate", "ISPS Pre-arrival"
  category     String  @default("arrival") // arrival, departure, cargo, customs, immigration, health
  required     Boolean @default(true)
  leadTimeDays Int? // how many days before arrival
  notes        String?

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())

  @@index([portId])
  @@index([country])
  @@map("port_document_requirements")
}

// === Contract of Affreightment (COA) ===

model ContractOfAffreightment {
  id                 String   @id @default(cuid())
  reference          String   @unique // COA-0001
  charterId          String   @unique // links to Charter with type='coa'
  cargoType          String
  totalQuantity      Float // total contracted MT
  tolerance          Float    @default(5) // percentage +/- tolerance
  nominatedQty       Float    @default(0) // total nominated so far
  shippedQty         Float    @default(0) // total shipped so far
  shipmentCount      Int      @default(0) // total shipments
  maxShipments       Int? // max allowed shipments
  loadPortRange      String? // port range description
  dischargePortRange String?
  startDate          DateTime
  endDate            DateTime
  freightRate        Float?
  freightUnit        String? // per_mt, lumpsum
  currency           String   @default("USD")
  status             String   @default("active") // active, completed, expired, cancelled
  organizationId     String
  notes              String?

  charter      Charter         @relation(fields: [charterId], references: [id])
  organization Organization    @relation(fields: [organizationId], references: [id])
  nominations  COANomination[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@map("contracts_of_affreightment")
}

// === COA Nomination ===

model COANomination {
  id            String    @id @default(cuid())
  coaId         String
  voyageId      String? // linked voyage once nominated
  shipmentNo    Int // sequential within COA
  quantity      Float // nominated MT
  tolerance     Float? // specific tolerance override
  loadPort      String?
  dischargePort String?
  laycanStart   DateTime?
  laycanEnd     DateTime?
  vesselName    String? // nominated vessel (may not be in system)
  status        String    @default("pending") // pending, accepted, rejected, shipped, completed
  notes         String?

  coa    ContractOfAffreightment @relation(fields: [coaId], references: [id])
  voyage Voyage?                 @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coaId])
  @@index([status])
  @@map("coa_nominations")
}

// === Fixture Subject Tracking ===

model FixtureSubject {
  id          String    @id @default(cuid())
  charterId   String
  type        String // sub_stem, sub_board, sub_charterers, sub_receivers, sub_shippers, sub_details
  description String
  deadline    DateTime // when subjects must be lifted
  liftedAt    DateTime? // when actually lifted
  liftedBy    String? // who lifted
  status      String    @default("open") // open, lifted, failed, withdrawn
  notes       String?

  charter Charter @relation(fields: [charterId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([charterId])
  @@index([status])
  @@map("fixture_subjects")
}

// === Charter Party Addendum ===

model CharterPartyAddendum {
  id             String    @id @default(cuid())
  charterPartyId String
  version        Int       @default(1) // sequential version number
  title          String // e.g., "Addendum No. 1 - Rate Adjustment"
  description    String?
  content        String? // full addendum text
  effectiveDate  DateTime
  signedDate     DateTime?
  status         String    @default("draft") // draft, signed, superseded

  charterParty CharterParty @relation(fields: [charterPartyId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([charterPartyId])
  @@map("charter_party_addenda")
}

// === Cargo Quantity Log ===

model CargoQuantityLog {
  id       String   @id @default(cuid())
  voyageId String
  portId   String?
  type     String // bl_figure, ship_figure, shore_figure, draft_survey, ullage
  quantity Float
  unit     String   @default("MT") // MT, CBM, barrels
  source   String? // surveyor name, B/L number, ship's figures
  remarks  String?
  loggedAt DateTime @default(now())
  loggedBy String?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())

  @@index([voyageId])
  @@index([type])
  @@map("cargo_quantity_logs")
}

model Nomination {
  id          String    @id @default(cuid())
  voyageId    String
  portCallId  String? // links to VoyagePortCall
  type        String // vessel, berth, surveyor, agent, stevedore
  entityName  String // name of nominated entity
  entityId    String? // optional link to vessel/company/contact
  status      String    @default("pending") // pending, confirmed, rejected, cancelled
  nominatedBy String?
  nominatedAt DateTime  @default(now())
  confirmedAt DateTime?
  notes       String?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("nominations")
}

model VoyagePortCall {
  id        String    @id @default(cuid())
  voyageId  String
  portId    String
  sequence  Int // order in rotation (1, 2, 3...)
  purpose   String // loading, discharging, bunkering, transit, crew_change, repairs
  eta       DateTime?
  etd       DateTime?
  ata       DateTime? // actual time of arrival
  atd       DateTime? // actual time of departure
  berthName String?
  cargoOp   String? // cargo operation details
  cargoQty  Float? // quantity in MT
  status    String    @default("planned") // planned, approaching, arrived, alongside, departed, skipped
  notes     String?

  voyage Voyage @relation(fields: [voyageId], references: [id])
  port   Port   @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([voyageId, sequence])
  @@map("voyage_port_calls")
}

model VoyageEstimateHistory {
  id              String  @id @default(cuid())
  voyageId        String?
  charterId       String?
  label           String // "V/E #1", "Counter-offer", etc.
  vesselName      String?
  vesselDwt       Float?
  cargoQuantity   Float
  freightRate     Float
  freightUnit     String  @default("per_mt")
  seaDistanceNm   Float
  speedKnots      Float   @default(13.5)
  loadDays        Float   @default(3)
  dischargeDays   Float   @default(4)
  bunkerPriceIfo  Float   @default(450)
  bunkerPriceMgo  Float   @default(850)
  loadPortDa      Float   @default(45000)
  dischargePortDa Float   @default(55000)
  canalDues       Float   @default(0)
  // Calculated results
  grossRevenue    Float   @default(0)
  netRevenue      Float   @default(0)
  totalCosts      Float   @default(0)
  netResult       Float   @default(0)
  tce             Float   @default(0)
  totalDays       Float   @default(0)
  currency        String  @default("USD")
  notes           String?
  createdBy       String?

  createdAt DateTime @default(now())

  @@index([voyageId])
  @@index([charterId])
  @@map("voyage_estimate_history")
}

model DelayAlert {
  id          String    @id @default(cuid())
  voyageId    String
  portCallId  String?
  type        String // late_arrival, late_departure, extended_port_stay, weather, congestion, mechanical, customs, cargo, other
  severity    String    @default("warning") // info, warning, critical
  rootCause   String? // weather, congestion, mechanical_failure, port_authority, customs_hold, cargo_issue, crew_issue, bunker_delay, canal_queue, other
  description String
  delayHours  Float? // estimated delay in hours
  eta         DateTime? // revised ETA
  resolvedAt  DateTime?
  resolvedBy  String?
  notes       String?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([voyageId])
  @@map("delay_alerts")
}

model CreditDebitNote {
  id                    String    @id @default(cuid())
  disbursementAccountId String
  type                  String // credit, debit
  amount                Float
  currency              String    @default("USD")
  reason                String // overcharge, undercharge, service_not_rendered, additional_service, rate_adjustment, penalty
  description           String
  status                String    @default("draft") // draft, issued, accepted, disputed, settled
  issuedTo              String? // company name
  referenceNumber       String?
  issuedAt              DateTime?
  settledAt             DateTime?
  notes                 String?

  disbursementAccount DisbursementAccount @relation(fields: [disbursementAccountId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([disbursementAccountId])
  @@map("credit_debit_notes")
}

// === Role Permissions ===

model RolePermission {
  id             String  @id @default(cuid())
  role           String // admin, manager, operator, viewer, chartering_manager, broker, port_agent, da_clerk, finance_manager, compliance_officer, vessel_master, surveyor
  module         String // vessels, voyages, chartering, da_desk, laytime, claims, bunkers, crew, compliance, contacts, invoices, reports, analytics, settings
  canCreate      Boolean @default(false)
  canRead        Boolean @default(true)
  canUpdate      Boolean @default(false)
  canDelete      Boolean @default(false)
  canApprove     Boolean @default(false)
  canExport      Boolean @default(false)
  organizationId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([role, module, organizationId])
  @@map("role_permissions")
}

// === Vendor Management ===

model PreferredVendor {
  id             String  @id @default(cuid())
  companyId      String
  organizationId String
  portId         String?
  serviceType    String // port_agent, stevedore, surveyor, bunker_supplier, towage, pilotage
  priority       Int     @default(1) // 1 = top preference
  notes          String?
  addedBy        String?

  company      Company      @relation(fields: [companyId], references: [id])
  organization Organization @relation("PreferredVendors", fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@unique([companyId, organizationId, serviceType, portId])
  @@map("preferred_vendors")
}

model VendorBlacklist {
  id             String    @id @default(cuid())
  companyId      String
  organizationId String
  reason         String // poor_performance, fraud, overcharging, non_compliance, sanctions, dispute, other
  description    String?
  severity       String    @default("blocked") // warning, restricted, blocked
  blacklistedBy  String?
  reviewDate     DateTime?

  company      Company      @relation(fields: [companyId], references: [id])
  organization Organization @relation("VendorBlacklist", fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, organizationId])
  @@map("vendor_blacklist")
}

// === Claim Evidence ===

model ClaimEvidence {
  id           String    @id @default(cuid())
  claimId      String
  documentType String // sof, nor, weather_report, terminal_record, pumping_log, photo, survey_report, correspondence, b_l, charter_party
  description  String
  filePath     String?
  fileName     String?
  fileSize     Int?
  uploadedBy   String?
  verified     Boolean   @default(false)
  verifiedBy   String?
  verifiedAt   DateTime?
  notes        String?

  claim Claim @relation(fields: [claimId], references: [id])

  createdAt DateTime @default(now())

  @@index([claimId])
  @@map("claim_evidence")
}

// === Port Restrictions ===

model PortRestriction {
  id              String  @id @default(cuid())
  portId          String
  maxDraft        Float? // meters
  maxLOA          Float? // meters
  maxBeam         Float? // meters
  maxDWT          Float? // tonnes
  maxAirDraft     Float? // meters (for bridges/cranes)
  tidalRange      Float? // meters
  channelDepth    Float? // meters at chart datum
  cargoHandling   String? // grab, conveyor, pneumatic, STS, etc.
  maxCargoRate    Float? // MT per day
  terminalType    String? // bulk, liquid, container, ro-ro, multipurpose
  restrictions    String? // free-form notes on special restrictions
  nightNavigation Boolean @default(true)
  pilotMandatory  Boolean @default(true)

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portId])
  @@map("port_restrictions")
}

// === Document Templates ===

model DocumentTemplate {
  id             String  @id @default(cuid())
  name           String
  category       String // charter_party, bill_of_lading, letter_of_credit, agency_agreement, survey_report, claim_letter, invoice, pda, fixture_recap, sof, nor, addendum
  subCategory    String? // e.g., "gencon", "asbatankvoy", "nype" for C/P
  description    String?
  content        String // template content (markdown/text with {{placeholders}})
  placeholders   String? // JSON array of placeholder names
  isDefault      Boolean @default(false)
  organizationId String?
  version        Int     @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@map("document_templates")
}

// === Bunker RFQ ===

model BunkerRFQ {
  id           String    @id @default(cuid())
  vesselId     String
  voyageId     String?
  portId       String
  fuelType     String // ifo380, ifo180, vlsfo, mgo, lsmgo, lng, methanol
  quantity     Float // MT
  deliveryDate DateTime?
  status       String    @default("draft") // draft, sent, quotes_received, awarded, cancelled
  notes        String?

  vessel Vessel        @relation(fields: [vesselId], references: [id])
  port   Port          @relation("BunkerPort", fields: [portId], references: [id])
  quotes BunkerQuote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
  @@index([portId])
  @@map("bunker_rfqs")
}

model BunkerQuote {
  id             String    @id @default(cuid())
  rfqId          String
  supplierId     String? // Company ID
  supplierName   String
  pricePerMt     Float
  currency       String    @default("USD")
  deliveryMethod String    @default("barge") // barge, truck, pipeline, ex-wharf
  minQuantity    Float?
  maxQuantity    Float?
  validUntil     DateTime?
  status         String    @default("pending") // pending, accepted, rejected, expired
  notes          String?

  rfq BunkerRFQ @relation(fields: [rfqId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([rfqId])
  @@map("bunker_quotes")
}

// === Fuel Quality ===

model FuelQualityRecord {
  id               String  @id @default(cuid())
  vesselId         String?
  voyageId         String?
  portId           String?
  fuelType         String // ifo380, ifo180, vlsfo, mgo, lsmgo
  supplierName     String?
  bdn              String? // Bunker Delivery Note reference
  quantity         Float // MT delivered
  density          Float? // kg/m3
  viscosity        Float? // cSt at 50C
  sulphur          Float? // % m/m
  water            Float? // % v/v
  flashPoint       Float? // C
  pourPoint        Float? // C
  ash              Float? // % m/m
  vanadium         Float? // mg/kg
  aluminum         Float? // mg/kg (cat fines)
  silicon          Float? // mg/kg (cat fines)
  isoCompliant     Boolean @default(true) // ISO 8217 compliant
  issueFound       Boolean @default(false)
  issueDescription String?
  sampleSent       Boolean @default(false)
  labReportRef     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("fuel_quality_records")
}

// === Vessel Emissions ===

model VesselEmission {
  id                    String  @id @default(cuid())
  vesselId              String
  voyageId              String?
  year                  Int
  reportingPeriod       String  @default("annual") // annual, voyage, quarterly
  // CII Data
  distanceNm            Float   @default(0)
  fuelConsumedMt        Float   @default(0)
  co2EmissionsMt        Float   @default(0)
  attainedCII           Float   @default(0)
  requiredCII           Float   @default(0)
  ciiRating             String? // A, B, C, D, E
  // EU ETS Data
  euEtsApplicable       Boolean @default(false)
  euEtsCo2Mt            Float   @default(0)
  euEtsAllowancesNeeded Int     @default(0)
  euEtsCostEur          Float   @default(0)
  // FuelEU Maritime
  fuelEuGhgIntensity    Float   @default(0) // gCO2eq/MJ
  fuelEuTarget          Float   @default(0) // gCO2eq/MJ target
  fuelEuCompliant       Boolean @default(true)
  fuelEuPenalty         Float   @default(0)
  notes                 String?

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
  @@index([year])
  @@map("vessel_emissions")
}

//  Geofencing 
model Geofence {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  description       String?
  // Circle geofence
  centerLat         Float
  centerLon         Float
  radiusNm          Float    @default(5) // nautical miles
  // Polygon geofence (alternative)
  polygonCoords     Json? // [{lat,lon}] array
  fenceType         String   @default("circle") // circle, polygon, port_area
  // Monitoring
  vesselIds         String[] // vessels to monitor
  alertOnEntry      Boolean  @default(true)
  alertOnExit       Boolean  @default(true)
  alertOnDwell      Boolean  @default(false)
  dwellThresholdHrs Float    @default(24)
  active            Boolean  @default(true)

  alerts       GeofenceAlert[]
  organization Organization    @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([active])
  @@map("geofences")
}

model GeofenceAlert {
  id             String    @id @default(cuid())
  geofenceId     String
  vesselId       String
  voyageId       String?
  eventType      String // entry, exit, dwell_exceeded
  latitude       Float
  longitude      Float
  speed          Float? // knots at time of event
  heading        Float?
  acknowledged   Boolean   @default(false)
  acknowledgedBy String?
  acknowledgedAt DateTime?
  notes          String?

  geofence Geofence @relation(fields: [geofenceId], references: [id])
  vessel   Vessel   @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())

  @@index([geofenceId])
  @@index([vesselId])
  @@index([acknowledged])
  @@map("geofence_alerts")
}

//  Approval Workflows 
model ApprovalRoute {
  id               String  @id @default(cuid())
  organizationId   String
  name             String
  entityType       String // charter, voyage, da, claim, invoice, bunker_rfq
  triggerCondition String? // e.g. "amount > 50000", "status = pending"
  autoApprove      Boolean @default(false)
  autoApproveBelow Float? // auto-approve if amount below this
  active           Boolean @default(true)

  steps        ApprovalStep[]
  organization Organization   @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([entityType])
  @@map("approval_routes")
}

model ApprovalStep {
  id              String    @id @default(cuid())
  approvalRouteId String
  stepOrder       Int
  approverRole    String // role required to approve
  approverUserId  String? // specific user (optional)
  action          String    @default("pending") // pending, approved, rejected, skipped
  actionBy        String?
  actionAt        DateTime?
  comments        String?
  entityType      String? // what entity this step was applied to
  entityId        String? // specific entity instance
  deadline        DateTime? // SLA deadline for this step

  approvalRoute ApprovalRoute @relation(fields: [approvalRouteId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([approvalRouteId])
  @@index([action])
  @@map("approval_steps")
}

//  Expiry & Certificate Alerts 
model ExpiryAlert {
  id              String    @id @default(cuid())
  organizationId  String
  entityType      String // vessel_certificate, crew_certificate, insurance, class_survey, p_and_i
  entityId        String
  entityName      String // human-readable name
  vesselId        String?
  crewMemberId    String?
  expiryDate      DateTime
  alertDaysBefore Int[]     @default([90, 60, 30, 14, 7]) // when to alert
  lastAlertSent   DateTime?
  status          String    @default("active") // active, renewed, expired, dismissed
  renewedDate     DateTime?
  renewedBy       String?
  notes           String?

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([entityType])
  @@index([expiryDate])
  @@index([status])
  @@map("expiry_alerts")
}

//  Mention / @mention Notifications 
model MentionNotification {
  id              String    @id @default(cuid())
  organizationId  String
  mentionedUserId String // user who was @mentioned
  mentionedBy     String // user who created the mention
  entityType      String // voyage, charter, claim, da, etc.
  entityId        String
  context         String // the text surrounding the mention
  fieldName       String? // which field contained the mention
  read            Boolean   @default(false)
  readAt          DateTime?

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([mentionedUserId])
  @@index([read])
  @@map("mention_notifications")
}

//  Charter Party Versioning 
model CharterPartyVersion {
  id               String   @id @default(cuid())
  charterPartyId   String
  versionNumber    Int
  content          String // full C/P text for this version
  changedBy        String // user who created this version
  changeReason     String? // e.g. "Updated demurrage rate", "Added rider clause"
  clausesChanged   String[] // list of clause names/numbers changed
  diffFromPrevious Json? // structured diff {added:[], removed:[], modified:[]}
  status           String   @default("draft") // draft, review, approved, superseded

  charterParty CharterParty @relation(fields: [charterPartyId], references: [id])

  createdAt DateTime @default(now())

  @@index([charterPartyId])
  @@index([versionNumber])
  @@map("charter_party_versions")
}

//  Port Agent Directory 
model PortAgent {
  id              String    @id @default(cuid())
  companyName     String
  contactPerson   String?
  email           String?
  phone           String?
  country         String
  city            String
  portIds         String[] // ports this agent covers
  serviceTypes    String[] // husbandry, protective, liner, customs, forwarding
  rating          Float     @default(0) // 0-5
  totalJobs       Int       @default(0)
  avgResponseHrs  Float     @default(0) // avg response time in hours
  isVerified      Boolean   @default(false)
  verifiedDate    DateTime?
  licenseNumber   String?
  insuranceCover  Float? // insurance coverage amount
  insuranceExpiry DateTime?
  notes           String?
  active          Boolean   @default(true)

  appointments AgentAppointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([country])
  @@index([rating])
  @@index([active])
  @@map("port_agents")
}

model AgentAppointment {
  id                String    @id @default(cuid())
  organizationId    String
  agentId           String
  voyageId          String?
  portId            String?
  portName          String?
  serviceType       String // husbandry, protective, liner, customs
  status            String    @default("pending") // pending, confirmed, active, completed, cancelled
  appointedDate     DateTime  @default(now())
  startDate         DateTime?
  endDate           DateTime?
  estimatedCost     Float?
  actualCost        Float?
  currency          String    @default("USD")
  instructions      String? // special instructions
  performanceRating Float? // post-job rating 0-5
  performanceNotes  String?

  agent        PortAgent    @relation(fields: [agentId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([agentId])
  @@index([organizationId])
  @@index([status])
  @@map("agent_appointments")
}

//  Bunker Quantity Disputes 
model BunkerQuantityDispute {
  id              String  @id @default(cuid())
  organizationId  String
  vesselId        String
  voyageId        String?
  portName        String
  fuelType        String // HFO, VLSFO, MGO, LNG
  deliveredQtyMt  Float // as per BDN (Bunker Delivery Note)
  claimedQtyMt    Float // as per vessel measurement
  discrepancyMt   Float // delivered - claimed
  discrepancyPct  Float // percentage difference
  unitPrice       Float   @default(0)
  disputeValueUsd Float   @default(0)
  supplierName    String?
  status          String  @default("open") // open, investigation, negotiation, settled, closed
  resolution      String? // accepted, partial_credit, full_credit, rejected
  creditAmount    Float?
  surveyorReport  String? // document reference
  notes           String?

  organization Organization @relation(fields: [organizationId], references: [id])
  vessel       Vessel       @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([vesselId])
  @@index([status])
  @@map("bunker_quantity_disputes")
}

//  Claim Package (Auto-assembled) 
model ClaimPackage {
  id                  String    @id @default(cuid())
  claimId             String
  packageType         String // demurrage, cargo_damage, cargo_shortage, deviation, dead_freight
  status              String    @default("assembling") // assembling, complete, submitted, acknowledged
  // Document checklist
  hasNoticeOfClaim    Boolean   @default(false)
  hasStatementOfFacts Boolean   @default(false)
  hasNorDocument      Boolean   @default(false)
  hasLaytimeCalc      Boolean   @default(false)
  hasSurveyReport     Boolean   @default(false)
  hasWeatherLog       Boolean   @default(false)
  hasPhotos           Boolean   @default(false)
  hasBolCopy          Boolean   @default(false)
  hasCharterPartyCopy Boolean   @default(false)
  hasCorrespondence   Boolean   @default(false)
  // Completeness
  totalDocsRequired   Int       @default(0)
  totalDocsPresent    Int       @default(0)
  completenessScore   Float     @default(0) // 0-100%
  submittedTo         String? // counterparty or P&I club
  submittedAt         DateTime?
  acknowledgedAt      DateTime?
  notes               String?

  claim Claim @relation(fields: [claimId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([claimId])
  @@index([status])
  @@map("claim_packages")
}

//  Port Cost Benchmarks 
model PortCostBenchmark {
  id            String   @id @default(cuid())
  portId        String
  portName      String
  vesselType    String // bulk_carrier, tanker, container, general_cargo
  dwtRange      String // "0-30000", "30000-60000", "60000-100000", "100000+"
  costCategory  String // pilotage, towage, berth_dues, mooring, port_dues, agency_fees, total
  avgCostUsd    Float    @default(0)
  minCostUsd    Float    @default(0)
  maxCostUsd    Float    @default(0)
  medianCostUsd Float    @default(0)
  sampleSize    Int      @default(0)
  periodStart   DateTime
  periodEnd     DateTime
  currency      String   @default("USD")
  trend         String   @default("stable") // rising, falling, stable
  trendPct      Float    @default(0) // % change from previous period
  notes         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portId])
  @@index([vesselType])
  @@index([costCategory])
  @@map("port_cost_benchmarks")
}

//  Weather Working Days 
model WeatherWorkingDay {
  id               String   @id @default(cuid())
  voyageId         String
  portCallId       String? // optional link to VoyagePortCall
  portName         String
  date             DateTime
  weatherCondition String // clear, rain, heavy_rain, storm, fog, high_wind, swell
  windSpeedKnots   Float?
  waveHeightM      Float?
  visibility       String? // good, moderate, poor, zero
  isWorkingDay     Boolean  @default(true)
  isWeatherDay     Boolean  @default(false) // true = weather prevented work
  hoursLost        Float    @default(0) // hours lost to weather
  deductionReason  String? // rain_stoppage, wind_exceeds_limit, swell, fog
  source           String   @default("manual") // manual, weather_api, vessel_log
  verifiedBy       String?
  notes            String?

  createdAt DateTime @default(now())

  @@index([voyageId])
  @@index([date])
  @@map("weather_working_days")
}

//  Vessel Certificates 
model VesselCertificate {
  id                String    @id @default(cuid())
  vesselId          String
  certificateType   String // safety_construction, safety_equipment, safety_radio, loadline, iopp, isps, ism_doc, ism_smc, marpol, ballast_water, class, tonnage, registry, minimum_safe_manning
  certificateNumber String?
  issuedBy          String? // DNV, LR, BV, ABS, flag state
  issuedDate        DateTime?
  expiryDate        DateTime?
  lastSurveyDate    DateTime?
  nextSurveyDue     DateTime?
  status            String    @default("valid") // valid, expired, suspended, withdrawn, pending_renewal
  documentUrl       String?
  notes             String?

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
  @@index([certificateType])
  @@index([expiryDate])
  @@map("vessel_certificates")
}

//  Insurance Policies 
model InsurancePolicy {
  id              String   @id @default(cuid())
  organizationId  String
  vesselId        String?
  policyType      String // hull_machinery, p_and_i, cargo, war_risk, loss_of_hire, freight_demurrage
  policyNumber    String?
  insurer         String // company name
  broker          String? // insurance broker
  insuredValue    Float    @default(0)
  deductible      Float    @default(0)
  premiumAnnual   Float    @default(0)
  currency        String   @default("USD")
  inceptionDate   DateTime
  expiryDate      DateTime
  status          String   @default("active") // active, expired, cancelled, under_renewal
  coverageDetails String? // description of coverage
  exclusions      String?
  renewalReminder Boolean  @default(true)
  notes           String?

  organization Organization @relation(fields: [organizationId], references: [id])
  vessel       Vessel?      @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([vesselId])
  @@index([policyType])
  @@index([expiryDate])
  @@map("insurance_policies")
}

//  Freight Market Indices 
model FreightIndex {
  id        String   @id @default(cuid())
  indexName String // BDI, BCI, BSI, BCTI, BDTI, BPI, BHI, S&P_500, etc.
  date      DateTime
  value     Float
  change    Float    @default(0) // absolute change from previous
  changePct Float    @default(0) // percentage change
  source    String   @default("baltic_exchange") // baltic_exchange, clarksons, platts
  notes     String?

  createdAt DateTime @default(now())

  @@unique([indexName, date])
  @@index([indexName])
  @@index([date])
  @@map("freight_indices")
}

//  Market Rates (Spot/TC) 
/// MarketRate - TimescaleDB hypertable (30-day chunks, 90-day compression, 5-year retention)
model MarketRate {
  id            String    @id @default(cuid())
  route         String // e.g., "C5 W.Australia-China", "TC2_37 Cont-USAC"
  vesselType    String // capesize, panamax, supramax, handysize, VLCC, suezmax, aframax, MR
  rateType      String // spot, time_charter, coa
  rate          Float // USD/MT for spot, USD/day for TC
  rateUnit      String    @default("usd_per_day") // usd_per_mt, usd_per_day, worldscale
  dwtMin        Int? // vessel size range
  dwtMax        Int?
  duration      String? // for TC: "1yr", "3yr", "6mo"
  effectiveDate DateTime
  expiryDate    DateTime?
  source        String    @default("market") // market, clarksons, broker_panel
  region        String? // pacific, atlantic, indian_ocean, global
  notes         String?

  createdAt DateTime @default(now())

  @@index([route])
  @@index([vesselType])
  @@index([effectiveDate])
  @@map("market_rates")
}

//  Hire Payment Schedule (TC) 
model HirePaymentSchedule {
  id                  String    @id @default(cuid())
  timeCharterId       String
  organizationId      String
  periodNumber        Int // 1, 2, 3... sequential hire periods
  periodStart         DateTime
  periodEnd           DateTime
  daysInPeriod        Float
  dailyRate           Float
  grossHire           Float // dailyRate  daysInPeriod
  // Deductions
  offHireDeduction    Float     @default(0)
  bunkerAdjustment    Float     @default(0)
  addressCommission   Float     @default(0) // typically 3.75%
  brokerCommission    Float     @default(0) // typically 1.25%
  otherDeductions     Float     @default(0)
  otherDeductionNotes String?
  netHire             Float // gross - all deductions
  // Payment
  invoiceNumber       String?
  invoiceDate         DateTime?
  dueDate             DateTime?
  paidDate            DateTime?
  paidAmount          Float?
  status              String    @default("draft") // draft, invoiced, paid, overdue, disputed
  notes               String?

  timeCharter  TimeCharter  @relation(fields: [timeCharterId], references: [id])
  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timeCharterId])
  @@index([organizationId])
  @@index([status])
  @@map("hire_payment_schedules")
}

//  Off-Hire Events (Enhanced) 
model OffHireEvent {
  id                String    @id @default(cuid())
  timeCharterId     String
  vesselId          String
  offHireType       String // breakdown, drydock, deviation, bunkering, crew_change, port_state_detention, strike, weather
  startDate         DateTime
  endDate           DateTime?
  durationHours     Float     @default(0)
  durationDays      Float     @default(0) // auto-calculated
  dailyRate         Float     @default(0) // hire rate for deduction calc
  deductionAmount   Float     @default(0) // dailyRate  durationDays
  // Details
  description       String?
  location          String? // port or position at time of event
  equipmentAffected String? // main engine, aux engine, crane, hatch cover, etc.
  sparePartsNeeded  String?
  repairCost        Float?
  // Resolution
  status            String    @default("ongoing") // ongoing, resolved, disputed, settled
  resolvedDate      DateTime?
  resolvedBy        String?
  disputeNotes      String?
  // Documentation
  surveyorReport    String?
  classNotification String?

  timeCharter TimeCharter @relation(fields: [timeCharterId], references: [id])
  vessel      Vessel      @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([timeCharterId])
  @@index([vesselId])
  @@index([status])
  @@map("off_hire_events")
}

//  Vessel Inspections (SIRE/CDI/PSC) 
model VesselInspection {
  id                String    @id @default(cuid())
  vesselId          String
  inspectionType    String // sire, cdi, psc, rightship, flag_state, class, internal, oil_major
  inspectorName     String?
  inspectorOrg      String? // e.g., "OCIMF", "Port Authority of Singapore", "Shell"
  inspectionDate    DateTime
  portOfInspection  String?
  // Results
  overallScore      Float? // 0-100 or star rating
  grade             String? // A, B, C, D, F or Pass/Fail
  deficienciesFound Int       @default(0)
  observationsCount Int       @default(0)
  // Deficiency categories
  navigation        Int       @default(0)
  safety            Int       @default(0)
  pollution         Int       @default(0)
  structural        Int       @default(0)
  operational       Int       @default(0)
  documentation     Int       @default(0)
  // Status
  status            String    @default("scheduled") // scheduled, in_progress, completed, closed_out
  closedOutDate     DateTime?
  closedOutBy       String?
  detentionIssued   Boolean   @default(false)
  detentionDays     Int       @default(0)
  reportUrl         String?
  notes             String?
  nextInspectionDue DateTime?

  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([vesselId])
  @@index([inspectionType])
  @@index([inspectionDate])
  @@map("vessel_inspections")
}

//  Document Links (Related Documents Graph) 
model DocumentLink {
  id             String  @id @default(cuid())
  organizationId String
  sourceDocType  String // charter_party, bol, invoice, claim, sof, nor, survey_report, etc.
  sourceDocId    String
  targetDocType  String
  targetDocId    String
  linkType       String // references, supersedes, amends, supports, contradicts, attachment_of
  description    String?
  createdBy      String?

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([sourceDocType, sourceDocId])
  @@index([targetDocType, targetDocId])
  @@map("document_links")
}

// === Batch 11: DA Desk + Voyage Ops + Auth ===

model CashToMaster {
  id             String    @id @default(cuid())
  organizationId String
  voyageId       String
  vesselId       String
  portId         String?
  currency       String    @default("USD")
  amount         Float
  exchangeRate   Float     @default(1.0)
  amountUsd      Float // Converted amount in USD
  purpose        String // crew_wages, victualling, stores, repairs, medical, port_charges, misc
  requestedBy    String?
  approvedBy     String?
  status         String    @default("requested") // requested, approved, disbursed, settled, rejected
  requestDate    DateTime  @default(now())
  disbursedDate  DateTime?
  settledDate    DateTime?
  receipt        String? // Receipt reference number
  remarks        String?

  organization Organization @relation(fields: [organizationId], references: [id])
  voyage       Voyage       @relation(fields: [voyageId], references: [id])
  vessel       Vessel       @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([organizationId])
  @@index([voyageId])
  @@index([vesselId])
  @@map("cash_to_master")
}

model EcaZone {
  id              String    @id @default(cuid())
  name            String // Baltic Sea SECA, North Sea SECA, North American ECA, US Caribbean ECA, Mediterranean SECA
  code            String    @unique // BALTIC_SECA, NORTH_SEA_SECA, NA_ECA, US_CARIBBEAN_ECA, MED_SECA
  type            String // seca (SOx), neca (NOx), ceca (CO2)
  fuelRequirement String? // max_sulphur_0.1, max_sulphur_0.5, tier_iii_nox
  description     String?
  polygon         Json // Array of [lat, lon] pairs defining zone boundary
  active          Boolean   @default(true)
  effectiveDate   DateTime?
  source          String? // IMO, EU, EPA

  createdAt DateTime @default(now())

  @@map("eca_zones")
}

model HighRiskArea {
  id                 String   @id @default(cuid())
  name               String // Gulf of Aden, West Africa, Southeast Asia, etc.
  code               String   @unique // GOA, WAFR, SEA, etc.
  riskType           String // piracy, war_risk, political, sanctions, environmental
  riskLevel          String // low, medium, high, critical
  description        String?
  polygon            Json // Array of [lat, lon] pairs defining zone boundary
  advisory           String? // Latest advisory text
  insuranceSurcharge Float? // Additional war risk premium percentage
  bmpRequired        Boolean  @default(false) // Best Management Practices required
  armedGuards        String? // recommended, mandatory, not_required
  active             Boolean  @default(true)
  lastUpdated        DateTime @default(now())
  source             String? // IMO, UKMTO, MSCHOA, ReCAAP

  createdAt DateTime @default(now())

  @@map("high_risk_areas")
}

model CriticalPathItem {
  id             String    @id @default(cuid())
  voyageId       String
  milestoneId    String?
  name           String // nor_tendered, berth_available, loading_commenced, loading_completed, docs_on_board, etc.
  category       String // port_ops, cargo_ops, documentation, regulatory, weather
  plannedStart   DateTime?
  plannedEnd     DateTime?
  actualStart    DateTime?
  actualEnd      DateTime?
  duration       Float? // Planned duration in hours
  actualDuration Float? // Actual duration in hours
  slack          Float? // Slack time in hours (0 = on critical path)
  isCritical     Boolean   @default(false)
  dependsOn      String[] // Array of CriticalPathItem IDs
  status         String    @default("pending") // pending, in_progress, completed, delayed, skipped
  delayReason    String?
  delayHours     Float?

  voyage Voyage @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  @@index([voyageId])
  @@map("critical_path_items")
}

model TeamInvitation {
  id             String    @id @default(cuid())
  organizationId String
  email          String
  role           String    @default("operator") // admin, manager, operator, viewer
  invitedBy      String // User ID of inviter
  token          String    @unique @default(cuid())
  status         String    @default("pending") // pending, accepted, expired, cancelled
  expiresAt      DateTime
  acceptedAt     DateTime?
  message        String? // Custom invitation message

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@unique([organizationId, email])
  @@index([token])
  @@map("team_invitations")
}

model BeaufortLog {
  id                  String   @id @default(cuid())
  voyageId            String
  vesselId            String
  reportDate          DateTime
  latitude            Float?
  longitude           Float?
  beaufortScale       Int // 0-12
  windSpeed           Float? // knots
  windDirection       Float? // degrees
  waveHeight          Float? // meters
  swellHeight         Float? // meters
  swellDirection      Float? // degrees
  seaState            String? // calm, slight, moderate, rough, very_rough, high, phenomenal
  visibility          Float? // nautical miles
  barometer           Float? // millibars
  airTemp             Float? // celsius
  seaTemp             Float? // celsius
  currentSpeed        Float? // knots
  currentDirection    Float? // degrees
  warrantySpeed       Float? // C/P warranty speed in knots
  actualSpeed         Float? // Actual speed in knots
  warrantyConsumption Float? // C/P warranty consumption in MT/day
  actualConsumption   Float? // Actual consumption in MT/day
  withinWarranty      Boolean  @default(true)
  remarks             String?

  voyage Voyage @relation(fields: [voyageId], references: [id])
  vessel Vessel @relation(fields: [vesselId], references: [id])

  createdAt DateTime @default(now())

  @@index([voyageId])
  @@index([vesselId])
  @@index([reportDate])
  @@map("beaufort_logs")
}

// === Phase 4: Ship Broking (S&P) ===

model SaleListing {
  id               String    @id @default(cuid())
  vesselId         String
  sellerOrgId      String
  askingPrice      Float
  currency         String    @default("USD")
  condition        String    @default("as_is") // as_is, drydocked, freshly_classed
  classStatus      String? // full_class, class_suspended, class_withdrawn
  specialSurveyDue DateTime?
  ddDueDate        DateTime? // drydock due date
  lastSurveyDate   DateTime?
  highlights       String? // key selling points
  photos           Json? // array of photo URLs
  brokerNotes      String?
  status           String    @default("draft") // draft, active, under_offer, sold, withdrawn
  publishedAt      DateTime?
  soldAt           DateTime?
  soldPrice        Float?

  vessel      Vessel          @relation(fields: [vesselId], references: [id])
  sellerOrg   Organization    @relation("SellerOrg", fields: [sellerOrgId], references: [id])
  interests   BuyerInterest[]
  offers      SNPOffer[]
  transaction SNPTransaction?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sellerOrgId])
  @@index([status])
  @@index([vesselId])
  @@map("sale_listings")
}

model BuyerInterest {
  id             String    @id @default(cuid())
  saleListingId  String
  buyerOrgId     String
  contactName    String?
  contactEmail   String?
  status         String    @default("expressed") // expressed, nda_signed, inspecting, offered, withdrawn
  ndaSignedAt    DateTime?
  inspectionDate DateTime?
  inspectionPort String?
  notes          String?

  saleListing SaleListing  @relation(fields: [saleListingId], references: [id])
  buyerOrg    Organization @relation("BuyerOrg", fields: [buyerOrgId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([saleListingId])
  @@index([buyerOrgId])
  @@map("buyer_interests")
}

model SNPOffer {
  id            String    @id @default(cuid())
  saleListingId String
  buyerOrgId    String
  sellerOrgId   String
  amount        Float
  currency      String    @default("USD")
  conditions    String? // conditions of the offer
  offerType     String    @default("initial") // initial, counter, final, best_and_final
  status        String    @default("submitted") // submitted, countered, accepted, rejected, expired, withdrawn
  expiresAt     DateTime?
  parentOfferId String? // for counter-offer chain
  respondedAt   DateTime?
  responseNotes String?

  saleListing   SaleListing  @relation(fields: [saleListingId], references: [id])
  buyerOrg      Organization @relation("SNPBuyerOrg", fields: [buyerOrgId], references: [id])
  sellerOrg     Organization @relation("SNPSellerOrg", fields: [sellerOrgId], references: [id])
  parentOffer   SNPOffer?    @relation("OfferChain", fields: [parentOfferId], references: [id])
  counterOffers SNPOffer[]   @relation("OfferChain")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([saleListingId])
  @@index([buyerOrgId])
  @@index([status])
  @@map("snp_offers")
}

model SNPTransaction {
  id                String    @id @default(cuid())
  saleListingId     String    @unique
  buyerOrgId        String
  sellerOrgId       String
  moaDate           DateTime?
  moaRef            String? // MOA reference number
  moaTemplate       String? // nsf_2012, ssf, custom
  purchasePrice     Float
  currency          String    @default("USD")
  depositAmount     Float?
  depositPercent    Float?    @default(10)
  depositDueDate    DateTime?
  depositPaidDate   DateTime?
  depositBankRef    String?
  deliveryDate      DateTime?
  deliveryPort      String?
  deliveryCondition String? // afs, as_is, class_maintained
  cancellationDate  DateTime?
  status            String    @default("moa_draft") // moa_draft, moa_signed, deposit_paid, pre_closing, inspection, closing, completed, cancelled

  saleListing  SaleListing            @relation(fields: [saleListingId], references: [id])
  buyerOrg     Organization           @relation("SNPTxBuyerOrg", fields: [buyerOrgId], references: [id])
  sellerOrg    Organization           @relation("SNPTxSellerOrg", fields: [sellerOrgId], references: [id])
  commissions  SNPCommission[]
  closingItems ClosingChecklistItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([buyerOrgId])
  @@index([sellerOrgId])
  @@index([status])
  @@map("snp_transactions")
}

model SNPCommission {
  id               String    @id @default(cuid())
  transactionId    String
  organizationId   String
  partyType        String // seller_broker, buyer_broker, intermediary
  commissionRate   Float // percentage (e.g., 1.0 = 1%)
  commissionAmount Float? // calculated from purchasePrice * rate / 100
  currency         String    @default("USD")
  invoiceRef       String?
  invoiceDate      DateTime?
  paidDate         DateTime?
  status           String    @default("pending") // pending, invoiced, paid, disputed

  transaction  SNPTransaction @relation(fields: [transactionId], references: [id])
  organization Organization   @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([organizationId])
  @@map("snp_commissions")
}

model ClosingChecklistItem {
  id            String    @id @default(cuid())
  transactionId String
  category      String // documents, flag, class, insurance, financial, operational, regulatory
  item          String // description of checklist item
  responsible   String? // who is responsible (buyer/seller/broker/agent)
  assignedTo    String? // specific person/org
  dueDate       DateTime?
  completedDate DateTime?
  status        String    @default("pending") // pending, in_progress, completed, waived, blocked
  notes         String?
  documentRef   String? // reference to uploaded doc

  transaction SNPTransaction @relation(fields: [transactionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([category])
  @@index([status])
  @@map("closing_checklist_items")
}

// === Phase 10: Trade Finance ===

model LetterOfCredit {
  id               String    @id @default(cuid())
  organizationId   String
  voyageId         String?
  reference        String    @unique
  type             String    @default("irrevocable") // irrevocable, confirmed, standby, transferable, back_to_back
  amount           Float
  currency         String    @default("USD")
  issuingBank      String
  advisingBank     String?
  confirmingBank   String?
  applicant        String // buyer/importer
  beneficiary      String // seller/exporter
  issueDate        DateTime?
  expiryDate       DateTime
  latestShipment   DateTime?
  portOfLoading    String?
  portOfDischarge  String?
  cargoDescription String?
  incoterms        String? // FOB, CIF, CFR, etc.
  paymentTerms     String? // at_sight, deferred_30, deferred_60, deferred_90, usance
  tolerancePercent Float?    @default(5) // +/- quantity tolerance
  partialShipment  Boolean   @default(false)
  transhipment     Boolean   @default(false)
  status           String    @default("draft") // draft, issued, advised, confirmed, drawing_submitted, documents_examined, discrepant, paid, expired, cancelled, amended

  organization Organization  @relation(fields: [organizationId], references: [id])
  voyage       Voyage?       @relation(fields: [voyageId], references: [id])
  documents    LCDocument[]
  amendments   LCAmendment[]
  drawings     LCDrawing[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([expiryDate])
  @@map("letters_of_credit")
}

model LCDocument {
  id               String    @id @default(cuid())
  letterOfCreditId String
  documentType     String // commercial_invoice, packing_list, bill_of_lading, certificate_of_origin, insurance_certificate, inspection_certificate, weight_certificate, phytosanitary
  required         Boolean   @default(true)
  copies           Int       @default(1)
  originals        Int       @default(0)
  description      String?
  submittedDate    DateTime?
  status           String    @default("pending") // pending, submitted, accepted, discrepant
  discrepancy      String?

  letterOfCredit LetterOfCredit @relation(fields: [letterOfCreditId], references: [id])

  createdAt DateTime @default(now())

  @@index([letterOfCreditId])
  @@map("lc_documents")
}

model LCAmendment {
  id               String    @id @default(cuid())
  letterOfCreditId String
  amendmentNumber  Int
  description      String
  previousValue    String?
  newValue         String?
  requestedBy      String // applicant or beneficiary
  requestedDate    DateTime  @default(now())
  approvedDate     DateTime?
  status           String    @default("requested") // requested, approved, rejected

  letterOfCredit LetterOfCredit @relation(fields: [letterOfCreditId], references: [id])

  createdAt DateTime @default(now())

  @@index([letterOfCreditId])
  @@map("lc_amendments")
}

model LCDrawing {
  id               String    @id @default(cuid())
  letterOfCreditId String
  drawingNumber    Int
  amount           Float
  currency         String
  presentationDate DateTime
  maturityDate     DateTime?
  documentsSent    Json? // list of documents submitted
  discrepancies    Json? // list of discrepancy descriptions
  status           String    @default("presented") // presented, documents_examined, accepted, discrepant, paid, refused

  letterOfCredit LetterOfCredit @relation(fields: [letterOfCreditId], references: [id])

  createdAt DateTime @default(now())

  @@index([letterOfCreditId])
  @@map("lc_drawings")
}

model TradePayment {
  id             String    @id @default(cuid())
  organizationId String
  voyageId       String?
  reference      String    @unique
  paymentType    String // freight_advance, freight_balance, demurrage, despatch, commission, da_payment, bunker_payment, hire_payment
  payer          String // org name or ID
  payee          String
  amount         Float
  currency       String    @default("USD")
  exchangeRate   Float?    @default(1)
  amountUsd      Float?
  dueDate        DateTime
  paidDate       DateTime?
  bankReference  String?
  swiftRef       String? // MT103 reference
  paymentMethod  String? // swift, tt, check, escrow, offset
  invoiceRef     String?
  notes          String?
  status         String    @default("pending") // pending, approved, processing, paid, overdue, disputed, cancelled

  organization Organization @relation(fields: [organizationId], references: [id])
  voyage       Voyage?      @relation(fields: [voyageId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([voyageId])
  @@index([status])
  @@index([dueDate])
  @@map("trade_payments")
}

model FXExposure {
  id              String    @id @default(cuid())
  organizationId  String
  currency        String // exposure currency
  baseCurrency    String    @default("USD")
  exposureType    String // receivable, payable
  amount          Float // amount in exposure currency
  spotRate        Float? // current spot rate
  hedgedAmount    Float?    @default(0)
  hedgeRate       Float?
  hedgeInstrument String? // forward, option, swap
  hedgeMaturity   DateTime?
  counterparty    String? // bank or counterparty
  voyageId        String?
  notes           String?
  status          String    @default("open") // open, partially_hedged, fully_hedged, settled

  organization Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([currency])
  @@index([status])
  @@map("fx_exposures")
}

// === Freight Derivatives (FFA) ===

model FFAPosition {
  id               String    @id @default(cuid())
  route            String // e.g. "TC2_37", "TD3C", "P1A_82", "C5TC"
  period           String // e.g. "Q1-2026", "Cal-2027", "Mar-2026"
  direction        String // long, short
  quantity         Float // number of lots
  lotSize          Float     @default(1000) // tons per lot
  entryPrice       Float // $/ton entry price
  currentPrice     Float? // latest settlement price
  mtmValue         Float? // mark-to-market P&L in USD
  clearingHouse    String? // LCH, ICE, SGX
  clearingRef      String? // clearing reference number
  margin           Float? // initial margin posted
  variationMargin  Float? // variation margin (daily P&L)
  counterparty     String?
  broker           String?
  physicalVoyageId String? // link to physical voyage for hedging
  status           String    @default("open") // open, partially_closed, closed, expired
  tradeDate        DateTime  @default(now())
  expiryDate       DateTime?
  notes            String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  trades         FFATrade[]
  pnlEntries     PnLEntry[]   @relation("FFAPnL")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([route])
  @@index([status])
  @@index([period])
  @@map("ffa_positions")
}

model FFATrade {
  id             String    @id @default(cuid())
  positionId     String
  tradeType      String // open, close, partial_close, roll
  direction      String // buy, sell
  quantity       Float // lots traded
  price          Float // execution price
  fees           Float     @default(0)
  clearingFee    Float     @default(0)
  brokerFee      Float     @default(0)
  counterparty   String?
  broker         String?
  tradeDate      DateTime  @default(now())
  settlementDate DateTime?
  reference      String? // trade confirmation ref

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  position       FFAPosition  @relation(fields: [positionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([positionId])
  @@index([organizationId])
  @@index([tradeDate])
  @@map("ffa_trades")
}

model VaRSnapshot {
  id              String   @id @default(cuid())
  snapshotDate    DateTime @default(now())
  portfolioValue  Float // total portfolio mark-to-market
  varOneDay95     Float // 1-day VaR at 95% confidence
  varOneDay99     Float // 1-day VaR at 99% confidence
  varTenDay95     Float // 10-day VaR at 95%
  varTenDay99     Float // 10-day VaR at 99%
  cvar95          Float? // Conditional VaR (Expected Shortfall) 95%
  maxDrawdown     Float?
  sharpeRatio     Float?
  positionCount   Int      @default(0)
  totalExposure   Float    @default(0) // total notional exposure
  methodology     String   @default("historical") // historical, parametric, monte_carlo
  confidenceLevel Float    @default(95)
  lookbackDays    Int      @default(252) // 1 year trading days
  notes           String?

  organizationId String

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([snapshotDate])
  @@map("var_snapshots")
}

model BacktestResult {
  id             String   @id @default(cuid())
  strategyName   String
  description    String?
  route          String // route tested
  periodStart    DateTime
  periodEnd      DateTime
  entryRule      String // description of entry logic
  exitRule       String // description of exit logic
  trades         Int      @default(0)
  winRate        Float? // percentage
  avgReturn      Float? // average return per trade
  totalReturn    Float? // total P&L
  maxDrawdown    Float?
  sharpeRatio    Float?
  sortinoRatio   Float?
  profitFactor   Float? // gross profit / gross loss
  avgHoldingDays Float?
  parameters     Json? // strategy parameters used

  organizationId String

  createdAt DateTime @default(now())

  @@index([organizationId])
  @@index([strategyName])
  @@index([route])
  @@map("backtest_results")
}

model PnLEntry {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  category     String // physical, paper, hedging, basis
  subcategory  String? // freight, demurrage, commission, ffa, option, bunker_hedge
  route        String?
  voyageId     String?
  positionId   String?
  revenue      Float    @default(0)
  cost         Float    @default(0)
  pnl          Float    @default(0) // revenue - cost
  currency     String   @default("USD")
  exchangeRate Float    @default(1)
  pnlUsd       Float    @default(0) // pnl in USD
  description  String?
  period       String? // Q1-2026, Jan-2026, etc.

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  position       FFAPosition? @relation("FFAPnL", fields: [positionId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([category])
  @@index([date])
  @@index([positionId])
  @@map("pnl_entries")
}

// === Compliance & Sanctions ===

model SanctionScreening {
  id            String    @id @default(cuid())
  entityType    String // vessel, company, individual, cargo
  entityName    String
  entityId      String? // reference to vessel/company/contact ID
  imoNumber     String? // for vessel screening
  flagState     String? // for vessel flag screening
  nationality   String? // for individual screening
  screeningType String // initial, periodic, transaction, enhanced
  status        String    @default("pending") // pending, clear, match, possible_match, escalated
  riskLevel     String? // low, medium, high, critical
  matchDetails  String? // description of any matches found
  sanctionLists String[] // which lists were checked: OFAC, EU, UN, UK_OFSI
  pepMatch      Boolean   @default(false)
  adverseMedia  Boolean   @default(false)
  screenedBy    String? // user who performed/reviewed
  reviewedBy    String? // compliance officer who approved
  reviewDate    DateTime?
  expiresAt     DateTime? // when re-screening is needed
  notes         String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([entityType])
  @@index([status])
  @@index([entityName])
  @@index([imoNumber])
  @@map("sanction_screenings")
}

model CounterpartyRiskScore {
  id                String    @id @default(cuid())
  companyId         String // reference to Company
  companyName       String
  overallScore      Float // 0-100 risk score (higher = riskier)
  riskCategory      String // low, medium, high, critical, unrated
  financialScore    Float? // financial health score 0-100
  complianceScore   Float? // compliance/sanctions score 0-100
  operationalScore  Float? // operational performance score 0-100
  reputationScore   Float? // reputation/media score 0-100
  sanctionRisk      Boolean   @default(false)
  pepExposure       Boolean   @default(false)
  adverseMedia      Boolean   @default(false)
  countryRisk       String? // risk level of domicile country
  lastScreeningDate DateTime?
  lastScreeningId   String? // reference to SanctionScreening
  creditLimit       Float? // recommended credit limit in USD
  paymentHistory    String? // good, fair, poor, no_history
  notes             String?
  validUntil        DateTime? // when reassessment is due

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, organizationId])
  @@index([organizationId])
  @@index([riskCategory])
  @@index([overallScore])
  @@map("counterparty_risk_scores")
}

model UltimateBeneficialOwner {
  id                 String    @id @default(cuid())
  companyId          String // reference to Company
  companyName        String
  ownerName          String
  nationality        String?
  dateOfBirth        DateTime?
  ownershipPercent   Float // percentage of ownership
  isDirectOwner      Boolean   @default(true)
  controlType        String    @default("ownership") // ownership, voting_rights, other_control
  pepStatus          Boolean   @default(false)
  sanctionStatus     String    @default("clear") // clear, match, pending_review
  verificationStatus String    @default("pending") // pending, verified, rejected, expired
  verifiedDate       DateTime?
  verifiedBy         String?
  documentRef        String? // KYC document reference
  expiresAt          DateTime? // when reverification is needed
  notes              String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([companyId])
  @@index([sanctionStatus])
  @@index([verificationStatus])
  @@map("ultimate_beneficial_owners")
}

// ======================================
// CRM MODULE (Phase 19)
// ======================================

model CommunicationLog {
  id           String    @id @default(cuid())
  type         String // email, call, meeting, whatsapp, note
  direction    String? // inbound, outbound
  subject      String?
  body         String?
  contactId    String? // linked Contact
  companyId    String? // linked Company
  voyageId     String? // linked Voyage
  charterId    String? // linked Charter
  claimId      String? // linked Claim
  leadId       String? // linked Lead
  fromAddress  String? // email from / caller ID
  toAddresses  String[] // email to / call recipients
  ccAddresses  String[] // email CC
  duration     Int? // call duration in seconds
  location     String? // meeting location
  meetingDate  DateTime? // scheduled meeting time
  attachments  String[] // file paths / URLs
  tags         String[] // free-form tags
  sentiment    String? // positive, neutral, negative (AI-analyzed)
  loggedBy     String? // user who logged this
  isAutoLogged Boolean   @default(false) // true if auto-captured from email/WhatsApp

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([contactId])
  @@index([companyId])
  @@index([leadId])
  @@index([type])
  @@map("communication_logs")
}

model Lead {
  id             String    @id @default(cuid())
  title          String // e.g. "VLCC AG-Japan Feb 2026"
  source         String // email, whatsapp, broker, website, conference, referral
  stage          String    @default("prospect") // prospect, qualified, proposal, negotiation, won, lost
  companyId      String? // linked Company (potential charterer/owner)
  companyName    String?
  contactId      String? // primary contact
  contactName    String?
  vesselType     String? // preferred vessel type
  cargoType      String? // cargo commodity
  route          String? // typical route/trade
  estimatedValue Float? // estimated fixture revenue in USD
  probability    Float? // win probability 0-100
  weightedValue  Float? // estimatedValue * probability / 100
  expectedClose  DateTime? // expected close date
  actualClose    DateTime?
  lostReason     String? // price, timing, vessel_quality, relationship, competitor
  notes          String?
  assignedTo     String? // user responsible

  activities LeadActivity[]

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([stage])
  @@index([companyId])
  @@index([assignedTo])
  @@map("leads")
}

model LeadActivity {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id])
  type        String // task, follow_up, meeting, call, email, note
  title       String
  description String?
  dueDate     DateTime?
  completedAt DateTime?
  status      String    @default("pending") // pending, completed, overdue, cancelled
  assignedTo  String?
  priority    String    @default("medium") // low, medium, high, urgent
  outcome     String? // result of the activity

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([leadId])
  @@index([status])
  @@index([dueDate])
  @@map("lead_activities")
}

model CustomerProfile {
  id                String    @id @default(cuid())
  companyId         String    @unique
  companyName       String
  customerSince     DateTime?
  totalFixtures     Int       @default(0)
  totalRevenue      Float     @default(0)
  avgFixtureValue   Float     @default(0)
  preferredRoutes   String[] // frequently used routes
  preferredVessels  String[] // preferred vessel types
  preferredCargoes  String[] // frequently shipped cargoes
  avgPaymentDays    Float? // average payment days
  outstandingAmount Float     @default(0)
  creditRating      String? // A, B, C, D
  relationshipScore Float? // 0-100 overall relationship health
  lastFixtureDate   DateTime?
  lastContactDate   DateTime?
  riskFlags         String[] // any risk flags
  tags              String[] // free-form categorization
  notes             String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([companyId, organizationId])
  @@index([organizationId])
  @@index([creditRating])
  @@map("customer_profiles")
}

// ======================================
// CARBON & SUSTAINABILITY (Phase 22)
// ======================================

model EtsAllowance {
  id             String    @id @default(cuid())
  vesselId       String? // specific vessel or fleet-wide
  vesselName     String?
  year           Int // compliance year
  type           String // purchase, surrender, carry_over, allocation
  quantity       Float // number of allowances (each = 1 tonne CO2)
  pricePerUnit   Float? // EUR per allowance
  totalCost      Float? // quantity * pricePerUnit
  currency       String    @default("EUR")
  source         String? // exchange (EEX/ICE), OTC, allocation, carry_forward
  status         String    @default("active") // active, surrendered, expired, transferred
  surrenderDate  DateTime?
  expiryDate     DateTime?
  tradeReference String? // exchange trade ref
  counterparty   String? // if OTC
  notes          String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([year])
  @@index([status])
  @@index([vesselId])
  @@map("ets_allowances")
}

model ImoDcsReport {
  id                String    @id @default(cuid())
  vesselId          String
  vesselName        String
  imoNumber         String
  year              Int // reporting year
  reportingPeriod   String // e.g. "2025-01-01 to 2025-12-31"
  flagState         String
  grossTonnage      Float
  netTonnage        Float?
  dwt               Float
  distanceTravelled Float // nautical miles
  hoursUnderway     Float
  fuelConsumption   Json // { fuelType: { consumption: kg, co2Factor: number } }
  totalCo2          Float // total CO2 emissions (tonnes)
  transportWork     Float? // cargo carried (tonnes) * distance (nm)
  eeoi              Float? // Energy Efficiency Operational Indicator
  ciiRating         String? // A, B, C, D, E
  ciiValue          Float? // actual CII value
  ciiRequired       Float? // required CII value for rating C
  submissionDate    DateTime?
  verifiedBy        String? // RO/classification society
  verificationDate  DateTime?
  status            String    @default("draft") // draft, submitted, verified, accepted, corrective_action
  notes             String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([vesselId, year, organizationId])
  @@index([organizationId])
  @@index([year])
  @@index([ciiRating])
  @@map("imo_dcs_reports")
}

model EsgReport {
  id                  String    @id @default(cuid())
  reportingPeriod     String // "Q1-2026", "2025"
  year                Int
  quarter             Int? // 1-4, null for annual
  scope1Emissions     Float // direct emissions (tonnes CO2e)  vessel fuel
  scope2Emissions     Float // indirect from purchased energy (tonnes CO2e)  office electricity
  scope3Emissions     Float? // value chain emissions (tonnes CO2e)  port ops, trucking
  totalEmissions      Float // scope1 + scope2 + (scope3 ?? 0)
  emissionIntensity   Float? // CO2 per tonne-mile or CO2 per DWT-mile
  renewableEnergy     Float? // % of energy from renewables
  shorePowerHours     Float? // hours of shore power used
  wasteRecycled       Float? // % of waste recycled
  spillIncidents      Int       @default(0) // number of oil/chemical spills
  safetyIncidents     Int       @default(0) // LTI count
  diversityScore      Float? // workforce diversity metric 0-100
  trainingHours       Float? // total crew training hours
  communityInvestment Float? // USD invested in community
  carbonOffset        Float? // tonnes CO2 offset purchased
  offsetCost          Float? // USD spent on offsets
  poseidonScore       Float? // Poseidon Principles alignment score
  seaCargoCharter     Float? // Sea Cargo Charter alignment score
  status              String    @default("draft") // draft, review, published
  publishedDate       DateTime?
  notes               String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, quarter, organizationId])
  @@index([organizationId])
  @@index([year])
  @@map("esg_reports")
}

model CarbonCredit {
  id                   String    @id @default(cuid())
  projectName          String // e.g. "Blue Carbon Mangrove Restoration"
  registry             String // verra, gold_standard, cdm, voluntary
  creditType           String // avoidance, removal, reduction
  vintage              Int // year the credit was generated
  quantity             Float // tonnes CO2
  pricePerTonne        Float // USD per tonne
  totalCost            Float // quantity * pricePerTonne
  currency             String    @default("USD")
  status               String    @default("active") // active, retired, transferred, expired
  retiredDate          DateTime?
  retiredForVessel     String? // vessel name if retired for specific vessel
  retiredForVoyage     String? // voyage reference if retired for specific voyage
  serialNumbers        String? // registry serial number range
  verificationStandard String? // e.g. VCS, GS
  projectCountry       String?
  notes                String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([vintage])
  @@map("carbon_credits")
}

// ======================================
// ANALYTICS & BI (Phase 16)
// ======================================

model RevenueForecast {
  id              String  @id @default(cuid())
  period          String // "Feb-2026", "Mar-2026"
  year            Int
  month           Int
  category        String // freight, hire, demurrage, commission, bunker_hedge, other
  projectedAmount Float // USD
  actualAmount    Float? // USD (filled later)
  variance        Float? // actual - projected
  confidence      Float? // 0-100 confidence level
  methodology     String? // weighted_pipeline, historical_avg, regression, manual
  assumptions     String? // key assumptions
  createdBy       String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year, month, category, organizationId])
  @@index([organizationId])
  @@index([year, month])
  @@map("revenue_forecasts")
}

model FixtureAnalytics {
  id             String  @id @default(cuid())
  period         String // "Jan-2026", "2025-Q4"
  periodType     String // monthly, quarterly, annual
  year           Int
  month          Int?
  quarter        Int?
  vesselType     String? // VLCC, Suezmax, Capesize, Panamax, Supramax, Handysize
  route          String? // AG-Japan, USG-Europe, etc.
  cargoType      String? // Crude, Coal, Grain, etc.
  fixtureCount   Int     @default(0)
  totalRevenue   Float   @default(0)
  avgFreightRate Float?
  avgCommission  Float? // commission % average
  avgLaytime     Float? // days
  avgDemurrage   Float? // USD
  avgTce         Float? // time charter equivalent $/day
  marketShare    Float? // estimated market share %
  winRate        Float? // fixtures won / enquiries %
  avgNegDays     Float? // average negotiation days

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([period, vesselType, route, organizationId])
  @@index([organizationId])
  @@index([year, month])
  @@index([vesselType])
  @@map("fixture_analytics")
}

model CashFlowEntry {
  id           String   @id @default(cuid())
  date         DateTime
  type         String // inflow, outflow
  category     String // freight_received, hire_received, demurrage_received, commission_received, pda_payment, bunker_payment, crew_wages, port_charges, canal_dues, insurance_premium, ets_payment, other
  description  String?
  amount       Float // positive for inflows, negative for outflows
  currency     String   @default("USD")
  amountUsd    Float? // USD equivalent
  voyageRef    String? // linked voyage
  vesselName   String?
  counterparty String?
  isProjected  Boolean  @default(false) // true for forecast entries
  isReconciled Boolean  @default(false)
  bankAccount  String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([date])
  @@index([category])
  @@index([isProjected])
  @@map("cash_flow_entries")
}

model TonnageHeatmap {
  id                String   @id @default(cuid())
  snapshotDate      DateTime
  region            String // AG, WAF, USG, ECSA, SEA, NOPAC, Med, Baltic, etc.
  vesselType        String // VLCC, Suezmax, Capesize, etc.
  availableCount    Int      @default(0) // open vessels in region
  onPassageCount    Int      @default(0) // vessels heading to region
  totalCount        Int      @default(0)
  avgAge            Float? // average fleet age in region
  demandCount       Int      @default(0) // active cargo enquiries
  supplyDemandRatio Float? // available / demand
  avgRate           Float? // average spot rate in region
  weekOverWeek      Float? // % change from last week

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())

  @@unique([snapshotDate, region, vesselType, organizationId])
  @@index([organizationId])
  @@index([snapshotDate])
  @@index([region])
  @@map("tonnage_heatmaps")
}

// ======================================
// HRMS MODULE (Phase 20)
// ======================================

model Employee {
  id               String    @id @default(cuid())
  employeeCode     String // e.g. "EMP-001"
  firstName        String
  lastName         String
  email            String
  phone            String?
  department       String // chartering, operations, snp, finance, it, hr, legal, management
  designation      String // Manager, Senior Analyst, Analyst, Executive, etc.
  role             String // office_staff, crew, management
  reportingTo      String? // employee ID of reporting manager
  dateOfJoining    DateTime
  dateOfExit       DateTime?
  employmentType   String    @default("full_time") // full_time, part_time, contract, intern
  status           String    @default("active") // active, on_leave, resigned, terminated
  officeLocation   String? // Mumbai, Singapore, London, Dubai
  salary           Float? // monthly CTC
  currency         String    @default("INR")
  bankAccount      String?
  ifscCode         String?
  panNumber        String?
  aadharNumber     String?
  emergencyContact String?
  emergencyPhone   String?
  profilePicture   String?

  leaveBalances  LeaveBalance[]
  attendanceLogs AttendanceLog[]
  payslips       Payslip[]

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeCode, organizationId])
  @@index([organizationId])
  @@index([department])
  @@index([status])
  @@map("employees")
}

model LeaveBalance {
  id             String   @id @default(cuid())
  employeeId     String
  employee       Employee @relation(fields: [employeeId], references: [id])
  year           Int
  leaveType      String // casual, sick, earned, maternity, paternity, compensatory, unpaid
  entitled       Float    @default(0) // total entitled days
  taken          Float    @default(0) // used days
  pending        Float    @default(0) // pending approval
  balance        Float    @default(0) // entitled - taken - pending
  carriedForward Float    @default(0) // from previous year

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, year, leaveType, organizationId])
  @@index([organizationId])
  @@index([employeeId])
  @@map("leave_balances")
}

model AttendanceLog {
  id          String    @id @default(cuid())
  employeeId  String
  employee    Employee  @relation(fields: [employeeId], references: [id])
  date        DateTime
  checkIn     DateTime?
  checkOut    DateTime?
  hoursWorked Float?
  status      String    @default("present") // present, absent, half_day, work_from_home, on_leave, holiday, weekend
  leaveType   String? // if on_leave: casual, sick, earned, etc.
  remarks     String?
  approvedBy  String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, date, organizationId])
  @@index([organizationId])
  @@index([employeeId])
  @@index([date])
  @@map("attendance_logs")
}

model Payslip {
  id              String    @id @default(cuid())
  employeeId      String
  employee        Employee  @relation(fields: [employeeId], references: [id])
  month           Int // 1-12
  year            Int
  basic           Float     @default(0)
  hra             Float     @default(0) // House Rent Allowance
  da              Float     @default(0) // Dearness Allowance
  specialAllow    Float     @default(0)
  otherAllow      Float     @default(0)
  grossEarnings   Float     @default(0)
  pf              Float     @default(0) // Provident Fund deduction
  esi             Float     @default(0) // Employee State Insurance
  tds             Float     @default(0) // Tax Deducted at Source
  professionalTax Float     @default(0)
  otherDeductions Float     @default(0)
  totalDeductions Float     @default(0)
  netPay          Float     @default(0) // grossEarnings - totalDeductions
  currency        String    @default("INR")
  status          String    @default("draft") // draft, processed, paid, held
  paidDate        DateTime?
  paymentRef      String? // NEFT/RTGS reference
  remarks         String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([employeeId, month, year, organizationId])
  @@index([organizationId])
  @@index([employeeId])
  @@index([year, month])
  @@index([status])
  @@map("payslips")
}

model TrainingRecord {
  id             String    @id @default(cuid())
  employeeId     String? // null for crew training linked via crewMemberId
  crewMemberId   String? // for crew-specific training
  employeeName   String
  trainingTitle  String
  category       String // SOLAS, MARPOL, ISM, ISPS, STCW, safety, technical, soft_skills, compliance
  provider       String? // training provider name
  startDate      DateTime
  endDate        DateTime?
  duration       Float? // hours
  status         String    @default("scheduled") // scheduled, in_progress, completed, cancelled, failed
  score          Float? // assessment score 0-100
  passFail       String? // pass, fail, n/a
  certificateRef String? // certificate number
  expiresAt      DateTime? // when recertification needed
  cost           Float? // training cost
  currency       String    @default("USD")
  notes          String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([employeeId])
  @@index([category])
  @@index([status])
  @@map("training_records")
}

// === Communication Hub (Phase 17) ===

model EmailMessage {
  id               String   @id @default(cuid())
  messageId        String?  @unique // IMAP message-id header
  threadId         String? // conversation thread grouping
  folder           String   @default("inbox") // inbox, sent, drafts, archive, trash
  direction        String   @default("inbound") // inbound, outbound
  fromAddress      String
  fromName         String?
  toAddresses      String[] // recipient email addresses
  ccAddresses      String[]
  bccAddresses     String[]
  subject          String
  bodyText         String? // plain text body
  bodyHtml         String? // HTML body
  snippet          String? // first 200 chars preview
  isRead           Boolean  @default(false)
  isStarred        Boolean  @default(false)
  isDraft          Boolean  @default(false)
  hasAttachments   Boolean  @default(false)
  attachmentNames  String[]
  // Deal linking
  voyageId         String?
  charterId        String?
  companyId        String?
  contactId        String?
  leadId           String?
  linkedEntityType String? // voyage, charter, company, contact, lead
  linkedEntityId   String?
  // AI-parsed metadata
  aiSummary        String? // AI-generated email summary
  aiSentiment      String? // positive, neutral, negative, urgent
  aiCategory       String? // fixture_negotiation, da_request, cargo_enquiry, general
  aiExtractedDates Json? // [{date, context}] extracted from body
  aiPriority       String? // high, medium, low

  userId         String? // user who owns this mailbox
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  receivedAt DateTime? // original email date
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@index([folder])
  @@index([threadId])
  @@index([voyageId])
  @@index([charterId])
  @@index([companyId])
  @@index([isRead])
  @@map("email_messages")
}

model NotificationDigest {
  id           String    @id @default(cuid())
  userId       String
  digestType   String    @default("daily") // daily, weekly, instant
  period       String // "2026-01-31", "2026-W05"
  status       String    @default("pending") // pending, generated, sent, failed
  channel      String    @default("email") // email, whatsapp, telegram, push
  // Digest content
  totalEvents  Int       @default(0)
  categories   Json? // { voyages: 3, charters: 2, alerts: 5 }
  highlights   Json? // [{title, type, entityId, priority}]
  htmlContent  String? // rendered digest HTML
  textContent  String? // plain text version
  // Delivery
  sentAt       DateTime?
  deliveredAt  DateTime?
  openedAt     DateTime?
  errorMessage String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, digestType, period])
  @@index([organizationId])
  @@index([userId])
  @@index([status])
  @@map("notification_digests")
}

// === Customs & CHA (Phase 11) ===

model CustomsDeclaration {
  id                String    @id @default(cuid())
  declarationType   String // igm, egm, boe, shipping_bill, transit
  referenceNumber   String    @unique
  status            String    @default("draft") // draft, filed, under_assessment, assessed, cleared, held, cancelled
  // Vessel / Voyage
  vesselId          String?
  vesselName        String?
  voyageId          String?
  voyageNumber      String?
  portOfOrigin      String?
  portOfDestination String?
  portOfDischarge   String?
  // Cargo details
  cargoDescription  String?
  hsCode            String? // primary HS code
  hsCodeDescription String?
  quantity          Float?
  unit              String? // MT, CBM, PKG, CTN
  grossWeight       Float?
  netWeight         Float?
  numberOfPackages  Int?
  containerNumbers  String[] // for containerized cargo
  // Valuation
  invoiceValue      Float?
  invoiceCurrency   String?   @default("USD")
  assessableValue   Float?
  exchangeRate      Float?
  cif               Float? // Cost, Insurance, Freight value
  // Duty
  basicDuty         Float?
  socialWelfare     Float?
  igst              Float?
  cess              Float?
  totalDuty         Float?
  dutyCurrency      String    @default("INR")
  // Parties
  importerExporter  String? // company name
  ieCode            String? // Import-Export code
  chaName           String? // Customs House Agent
  chaLicense        String? // CHA license number
  shippingLine      String?
  blNumber          String? // Bill of Lading number
  // Filing
  filedAt           DateTime?
  assessedAt        DateTime?
  clearedAt         DateTime?
  icegateRefId      String? // ICEGATE transaction ID
  notes             String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([declarationType])
  @@index([status])
  @@index([vesselId])
  @@index([hsCode])
  @@map("customs_declarations")
}

model HSCodeLookup {
  id                String  @id @default(cuid())
  hsCode            String // 2, 4, 6, or 8-digit HS code
  description       String
  chapter           String? // Chapter number (01-99)
  heading           String? // 4-digit heading
  subheading        String? // 6-digit subheading
  tariffItem        String? // 8-digit tariff item (country specific)
  unit              String? // default measurement unit
  // Duty rates (India default)
  basicDutyRate     Float? // BCD %
  socialWelfareRate Float? // SWS %
  igstRate          Float? // IGST %
  cessRate          Float? // Cess %
  // Restrictions
  isRestricted      Boolean @default(false)
  isProhibited      Boolean @default(false)
  requiresLicense   Boolean @default(false)
  exportRestricted  Boolean @default(false)
  // Classification
  category          String? // raw_material, intermediate, finished, capital_goods
  country           String  @default("IN") // country-specific tariff

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([hsCode, country, organizationId])
  @@index([organizationId])
  @@index([hsCode])
  @@index([chapter])
  @@map("hs_code_lookups")
}

model DeliveryOrder {
  id               String    @id @default(cuid())
  doNumber         String    @unique
  status           String    @default("pending") // pending, issued, released, collected, expired, cancelled
  // Vessel / Cargo
  vesselId         String?
  vesselName       String?
  voyageId         String?
  blNumber         String // associated B/L
  cargoDescription String?
  containerNumbers String[]
  numberOfPackages Int?
  grossWeight      Float?
  // Parties
  consigneeName    String
  consigneeAddress String?
  chaName          String? // clearing agent
  shippingLine     String?
  // Charges
  freightStatus    String? // prepaid, collect
  detentionCharges Float?
  demurrageCharges Float?
  otherCharges     Float?
  totalCharges     Float?
  chargeCurrency   String    @default("INR")
  isPaid           Boolean   @default(false)
  // Dates
  issuedAt         DateTime?
  validUntil       DateTime?
  collectedAt      DateTime?
  // Customs
  customsRefNumber String? // linked customs declaration
  notes            String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([blNumber])
  @@index([vesselId])
  @@map("delivery_orders")
}

model EwayBill {
  id                 String    @id @default(cuid())
  ewayBillNumber     String?   @unique // generated by GST portal
  status             String    @default("draft") // draft, generated, active, in_transit, delivered, cancelled, expired
  // Supply details
  supplyType         String // outward, inward
  subSupplyType      String? // supply, export, import, job_work, skd_ckd, etc.
  documentType       String? // invoice, bill_of_supply, delivery_challan, credit_note
  documentNumber     String?
  documentDate       DateTime?
  // From / To
  fromName           String?
  fromGstin          String?
  fromAddress        String?
  fromCity           String?
  fromState          String?
  fromPincode        String?
  toName             String?
  toGstin            String?
  toAddress          String?
  toCity             String?
  toState            String?
  toPincode          String?
  // Item details
  hsCode             String?
  productDescription String?
  quantity           Float?
  unit               String?
  taxableAmount      Float?
  cgstRate           Float?
  sgstRate           Float?
  igstRate           Float?
  cessRate           Float?
  totalInvoiceValue  Float?
  // Transport
  transporterName    String?
  transporterId      String? // GSTIN of transporter
  transportMode      String? // road, rail, ship, air
  vehicleNumber      String?
  vehicleType        String? // regular, over_dimensional
  distanceKm         Float?
  // Validity
  generatedAt        DateTime?
  validUntil         DateTime?
  cancelledAt        DateTime?
  cancelReason       String?
  // Linked entities
  voyageId           String?
  customsRefNumber   String?

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId])
  @@index([status])
  @@index([fromGstin])
  @@index([toGstin])
  @@index([vehicleNumber])
  @@map("eway_bills")
}

// Updated User model with password policy and MFA fields
// Note: This extends the existing User model above - merge these fields into line 82-98

// Add these fields to User model:
//   password           String   // Renamed from passwordHash for consistency
//   passwordHistory    Json?    @default("[]") // Array of previous password hashes
//   passwordChangedAt  DateTime @default(now())
//   passwordExpiresAt  DateTime?
//   failedLoginAttempts Int     @default(0)
//   lockedUntil        DateTime?
//   mfaEnabled         Boolean  @default(false)
//   mfaMethod          String?  // totp, sms
//   mfaSecret          String?  // TOTP secret
//   mfaBackupCodes     Json?    @default("[]") // Array of hashed backup codes
//   mfaPhoneNumber     String?  // E.164 format
//   mfaSmsCode         String?  // Temp SMS code
//   mfaSmsCodeExpiresAt DateTime?
//   failedMfaAttempts  Int      @default(0)

// FDA Dispute Resolution
model FdaDispute {
  id                    String  @id @default(cuid())
  disbursementAccountId String
  lineItemId            String? // specific line item if dispute is about one item
  disputeType           String // overcharge, missing_service, incorrect_calculation, unauthorized_charge
  status                String  @default("open") // open, under_review, resolved, escalated, closed
  priority              String  @default("medium") // low, medium, high, critical

  // Dispute details
  expectedAmount  Float
  actualAmount    Float
  varianceAmount  Float
  variancePercent Float
  disputeReason   String

  // Resolution
  resolution      String? // agreed_to_pay, credit_issued, charge_removed, split_difference
  resolvedAmount  Float?
  resolutionNotes String?
  resolvedBy      String?
  resolvedAt      DateTime?

  // Communication trail
  comments    FdaDisputeComment[]
  attachments FdaDisputeAttachment[]

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  disbursementAccount DisbursementAccount @relation(fields: [disbursementAccountId], references: [id])

  @@index([status, priority])
  @@index([disbursementAccountId])
  @@map("fda_disputes")
}

model FdaDisputeComment {
  id         String  @id @default(cuid())
  disputeId  String
  userId     String
  role       String // internal, agent, charterer, owner
  comment    String
  isInternal Boolean @default(false) // internal notes not visible to agent

  dispute FdaDispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([disputeId])
  @@map("fda_dispute_comments")
}

model FdaDisputeAttachment {
  id         String @id @default(cuid())
  disputeId  String
  fileName   String
  fileUrl    String
  fileType   String // invoice, receipt, email, contract, other
  uploadedBy String

  dispute FdaDispute @relation(fields: [disputeId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([disputeId])
  @@map("fda_dispute_attachments")
}

// === Vessel Ownership Cache (Equasis) ===

model VesselOwnershipCache {
  id        String   @id @default(cuid())
  imo       String   @unique
  data      Json // Complete Equasis data
  scrapedAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("vessel_ownership_cache")
}

// === ETA Prediction Logs (ML Learning) ===

model ETAPredictionLog {
  id               String    @id @default(cuid())
  voyageId         String
  portId           String
  predictedETA     DateTime
  actualATA        DateTime?
  predictionError  Int? // minutes difference
  confidence       Float
  weatherImpact    Json? // { delayMinutes, windSpeed, waveHeight }
  congestionImpact Json? // { delayMinutes, vesselsWaiting }
  factors          Json? // All prediction factors
  modelVersion     String    @default("1.0.0")
  createdAt        DateTime  @default(now())

  @@index([voyageId])
  @@index([portId])
  @@index([voyageId, createdAt])
  @@index([actualATA])
  @@map("eta_prediction_logs")
}

// === Tariff Ingestion & Review Tables ===

model TariffReviewTask {
  id            String   @id @default(cuid())
  portId        String
  extractedData Json // Raw extracted tariff data
  confidence    Float // 0-1 confidence score
  status        String   @default("pending") // pending, approved, rejected, archived
  issues        String[] // Array of validation issues

  // Source document
  sourceUrl    String?
  sourceHash   String? // SHA-256 hash for change detection
  documentPath String? // Path to stored PDF

  // Review
  reviewedBy  String?
  reviewedAt  DateTime?
  reviewNotes String?

  // Approval creates real tariffs
  approvedCount Int @default(0) // Number of tariffs created on approval

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portId])
  @@index([status])
  @@index([confidence])
  @@map("tariff_review_tasks")
}

model TariffIngestionJob {
  id       String @id @default(cuid())
  jobType  String // single_port, bulk_ports, update_detection
  status   String @default("queued") // queued, processing, completed, failed
  priority Int    @default(5) // 1-10, lower = higher priority

  // Configuration
  portIds String[] // Ports to process
  options Json? // Job-specific options

  // Progress
  totalPorts     Int @default(0)
  processedPorts Int @default(0)
  successCount   Int @default(0)
  failureCount   Int @default(0)
  reviewCount    Int @default(0) // Low-confidence requiring review

  // Timing
  startedAt    DateTime?
  completedAt  DateTime?
  estimatedEnd DateTime?

  // Results
  results  Json? // Detailed results per port
  errorLog String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([jobType])
  @@index([priority])
  @@map("tariff_ingestion_jobs")
}

model PortTariffDocument {
  id           String @id @default(cuid())
  portId       String
  documentUrl  String
  documentHash String // SHA-256 hash for change detection
  documentType String @default("tariff_schedule") // tariff_schedule, port_handbook, notice

  // Version tracking
  version      Int     @default(1)
  isActive     Boolean @default(true)
  supersededBy String? // ID of newer version

  // Extraction metadata
  extractedAt   DateTime?
  tariffCount   Int       @default(0)
  lastCheckedAt DateTime  @default(now())

  port Port @relation(fields: [portId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([portId, documentHash])
  @@index([portId])
  @@index([isActive])
  @@map("port_tariff_documents")
}

// ============================================================================
// PORT AGENCY PORTAL - Priority 1 Strategic Feature
// Created: February 2, 2026
// Purpose: PDA/FDA automation, service requests, multi-currency
// ============================================================================

// === 1. Agent Appointments ===

model PortAgentAppointment {
  id             String    @id @default(cuid())
  organizationId String
  vesselId       String
  portCode       String // UNLOCODE (SGSIN, INMUN, etc.)
  eta            DateTime
  etb            DateTime?
  etd            DateTime?
  serviceType    String // husbandry, cargo, crew_change, bunker
  status         String    @default("nominated") // nominated, confirmed, services_requested, completed
  nominatedBy    String?
  nominatedAt    DateTime?

  organization    Organization                  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  vessel          Vessel                        @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  pdas            ProformaDisbursementAccount[]
  fdas            FinalDisbursementAccount[]
  serviceRequests PortServiceRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portCode, eta])
  @@index([vesselId, status])
  @@map("port_agent_appointments")
}

// === 2. PDA (Proforma Disbursement Account) ===

model ProformaDisbursementAccount {
  id            String @id @default(cuid())
  appointmentId String
  reference     String @unique // PDA-SGSIN-2026-001
  version       Int    @default(1)
  status        String @default("draft") // draft, sent, approved, revised, cancelled

  // Port Details
  portCode      String
  portName      String
  arrivalDate   DateTime
  departureDate DateTime?
  stayDuration  Float? // hours

  // Vessel Details
  vesselId   String
  vesselName String
  imo        String
  flag       String?
  grt        Float?
  nrt        Float?
  loa        Float?
  beam       Float?
  draft      Float?

  // Financial
  baseCurrency     String  @default("USD")
  totalAmount      Float
  totalAmountLocal Float?
  localCurrency    String?
  fxRate           Float   @default(1.0)

  // Metadata
  generatedBy String? // user_id or "AUTO"
  generatedAt DateTime  @default(now())
  sentAt      DateTime?
  approvedAt  DateTime?
  approvedBy  String?

  // ML Prediction
  confidenceScore Float? // 0.0-1.0
  predictionModel String?

  appointment PortAgentAppointment           @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  vessel      Vessel                         @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  lineItems   ProformaDisbursementLineItem[]
  fda         FinalDisbursementAccount?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([portCode, arrivalDate])
  @@index([vesselId, status])
  @@index([reference])
  @@map("pdas")
}

// === 3. PDA Line Items ===

model ProformaDisbursementLineItem {
  id          String  @id @default(cuid())
  pdaId       String
  category    String // port_dues, pilotage, towage, mooring, agency_fee, etc.
  description String
  quantity    Float?
  unit        String? // per_grt, per_hour, lumpsum
  unitPrice   Float?
  amount      Float
  currency    String  @default("USD")

  // Tariff Reference
  tariffId     String?
  tariffSource String? // port_authority, vendor_quote, historical, ml_prediction

  // Vendor Quote
  vendorId        String?
  vendorQuoteId   String?
  quoteValidUntil DateTime?

  // Prediction
  isPredicted Boolean @default(false)
  confidence  Float? // 0.0-1.0

  pda    ProformaDisbursementAccount @relation(fields: [pdaId], references: [id], onDelete: Cascade)
  tariff PortTariff?                 @relation(fields: [tariffId], references: [id], onDelete: SetNull)
  vendor Company?                    @relation("PDALineItemVendor", fields: [vendorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([pdaId, category])
  @@map("pda_line_items")
}

// === 4. FDA (Final Disbursement Account) ===

model FinalDisbursementAccount {
  id            String @id @default(cuid())
  pdaId         String @unique
  appointmentId String
  reference     String @unique // FDA-SGSIN-2026-001

  // Financial
  baseCurrency     String  @default("USD")
  totalAmount      Float
  totalAmountLocal Float?
  localCurrency    String?
  fxRate           Float   @default(1.0)

  // Variance Analysis
  pdaTotal        Float
  variance        Float // FDA - PDA
  variancePercent Float // (variance / PDA) * 100

  // Status
  status      String    @default("draft") // draft, submitted, approved, settled
  submittedAt DateTime?
  approvedAt  DateTime?
  settledAt   DateTime?

  // Payment
  paymentMethod    String? // wire_transfer, check, account_credit
  paymentReference String?

  pda         ProformaDisbursementAccount @relation(fields: [pdaId], references: [id], onDelete: Cascade)
  appointment PortAgentAppointment        @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  lineItems   FinalDisbursementLineItem[]
  variances   FdaVarianceAnalysis[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([appointmentId])
  @@index([reference])
  @@map("fdas")
}

// === 5. FDA Line Items ===

model FinalDisbursementLineItem {
  id          String  @id @default(cuid())
  fdaId       String
  category    String
  description String
  quantity    Float?
  unit        String?
  unitPrice   Float?
  amount      Float
  currency    String  @default("USD")

  // Actual Invoice Reference
  invoiceId     String?
  invoiceNumber String?
  invoiceDate   DateTime?
  vendorId      String?

  // Variance from PDA
  pdaLineItemId String?
  pdaAmount     Float?
  variance      Float? // Actual - Estimated

  fda     FinalDisbursementAccount @relation(fields: [fdaId], references: [id], onDelete: Cascade)
  invoice Invoice?                 @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  vendor  Company?                 @relation("FDALineItemVendor", fields: [vendorId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fdaId, category])
  @@map("fda_line_items")
}

// === 6. FDA Variance Analysis ===

model FdaVarianceAnalysis {
  id              String  @id @default(cuid())
  fdaId           String
  category        String
  pdaAmount       Float
  fdaAmount       Float
  variance        Float // FDA - PDA
  variancePercent Float // (variance / PDA) * 100
  reason          String? // rate_change, additional_services, currency_fluctuation, etc.
  notes           String?

  fda FinalDisbursementAccount @relation(fields: [fdaId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([fdaId])
  @@map("fda_variances")
}

// === 7. Service Requests ===

model PortServiceRequest {
  id            String    @id @default(cuid())
  appointmentId String
  serviceType   String // pilotage, towage, mooring, garbage, freshwater, provisions
  description   String
  requestedAt   DateTime  @default(now())
  requiredBy    DateTime?

  // Status
  status String @default("pending") // pending, quoted, confirmed, completed, cancelled

  // Selected Quote
  selectedQuoteId String?

  // Completion
  completedAt DateTime?
  actualCost  Float?
  currency    String?
  rating      Int? // 1-5 stars
  review      String?

  appointment PortAgentAppointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  quotes      PortVendorQuote[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([appointmentId, status])
  @@map("service_requests")
}

// === 8. Vendor Quotes ===

model PortVendorQuote {
  id               String   @id @default(cuid())
  serviceRequestId String
  vendorId         String
  amount           Float
  currency         String   @default("USD")
  validUntil       DateTime
  description      String?
  terms            String? // Payment terms, conditions

  // Status
  status      String   @default("pending") // pending, accepted, rejected, expired
  respondedAt DateTime @default(now())

  serviceRequest PortServiceRequest @relation(fields: [serviceRequestId], references: [id], onDelete: Cascade)
  vendor         Company            @relation("PortVendorQuote", fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([serviceRequestId, status])
  @@map("vendor_quotes")
}

// === 9. Port Services (Master Data) ===

model PortServiceMaster {
  id          String  @id @default(cuid())
  portCode    String // UNLOCODE
  serviceType String // pilotage, towage, mooring, etc.
  vendorId    String
  isActive    Boolean @default(true)
  priority    Int     @default(1) // 1 = preferred vendor

  // Contact
  contactName  String?
  contactEmail String?
  contactPhone String?

  // Pricing (optional, for reference)
  baseRate Float?
  currency String?
  unit     String?
  notes    String?

  vendor Company @relation("PortServiceVendor", fields: [vendorId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([portCode, serviceType, vendorId])
  @@index([portCode, serviceType, isActive])
  @@map("port_services")
}

// ===============================
// INTELLIGENT ROUTING ENGINE WITH AUTO-LEARNING
// ===============================

// Vessel route with waypoints
model VesselRoute {
  id             String   @id @default(cuid())
  vesselId       String
  originPortId   String
  destPortId     String
  
  // Route metadata
  routeType      String   // 'CALCULATED', 'LEARNED', 'HISTORICAL', 'HYBRID'
  vesselType     String   // 'container', 'tanker', 'bulk_carrier', 'general_cargo'
  
  // Vessel characteristics at time of route
  draftMeters    Float?
  loaMeters      Float?
  beamMeters     Float?
  
  // Route quality metrics
  totalDistanceNm Float
  estimatedHours  Float
  fuelEstimateMt  Float?
  confidenceScore Float    @default(0.5) // 0-1, increases with learning
  
  // Learning metadata
  usageCount      Int      @default(0) // How many times this route was used
  successRate     Float    @default(1.0) // Success rate of completions
  avgActualHours  Float? // Average actual time taken
  lastUsedAt      DateTime?
  
  // Constraints considered
  avoidedEcaZones Boolean  @default(false)
  avoidedHighRisk Boolean  @default(false)
  consideredCongestion Boolean @default(false)
  consideredWeather Boolean @default(false)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  // Relations
  vessel       Vessel             @relation(fields: [vesselId], references: [id], onDelete: Cascade)
  originPort   Port               @relation("RouteOriginPort", fields: [originPortId], references: [id])
  destPort     Port               @relation("RouteDestPort", fields: [destPortId], references: [id])
  waypoints    VesselRouteWaypoint[]
  qualityLogs  RouteQualityLog[]
  
  @@index([vesselId, originPortId, destPortId])
  @@index([vesselType, originPortId, destPortId])
  @@index([confidenceScore])
  @@index([routeType])
  @@map("vessel_routes")
}

// Individual waypoint in a route
model VesselRouteWaypoint {
  id              String  @id @default(cuid())
  routeId         String
  sequenceNumber  Int     // Order in route (1, 2, 3...)
  
  // Position
  latitude        Float
  longitude       Float
  name            String? // Optional name (e.g., "Suez Canal Entry", "Singapore Strait")
  
  // Waypoint type
  waypointType    String  // 'DEPARTURE', 'WAYPOINT', 'CANAL', 'STRAIT', 'ANCHORAGE', 'ARRIVAL'
  
  // Distance and time to next waypoint
  distanceToNextNm Float?
  hoursToNext      Float?
  
  // Constraints at this waypoint
  minDraftMeters   Float?
  maxDraftMeters   Float?
  speedLimitKnots  Float?
  
  // Learning data
  avgSpeedKnots    Float? // Average speed vessels take through this point
  trafficDensity   String? // 'LOW', 'MEDIUM', 'HIGH' (learned from AIS)
  
  createdAt       DateTime @default(now())
  
  // Relations
  route VesselRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  
  @@unique([routeId, sequenceNumber])
  @@index([routeId])
  @@map("vessel_route_waypoints")
}

// Historical route quality tracking (learning data)
model RouteQualityLog {
  id              String   @id @default(cuid())
  routeId         String
  voyageId        String?  // Link to actual voyage if available
  
  // Planned vs Actual
  plannedHours    Float
  actualHours     Float?
  plannedFuelMt   Float?
  actualFuelMt    Float?
  
  // Quality indicators
  onTimeArrival   Boolean  @default(true)
  delayHours      Float?
  delayReason     String? // 'WEATHER', 'CONGESTION', 'MECHANICAL', 'OTHER'
  
  // Conditions during voyage
  weatherConditions String? // 'GOOD', 'MODERATE', 'SEVERE'
  congestionMet    Boolean  @default(false)
  routeDeviation   Float?   // Percentage deviation from planned route
  
  // Outcome
  completed       Boolean  @default(false)
  completedAt     DateTime?
  
  // Learning signals
  wouldRecommend  Boolean  @default(true)
  issuesEncountered String? // JSON array of issues
  
  createdAt       DateTime @default(now())
  
  // Relations
  route   VesselRoute @relation(fields: [routeId], references: [id], onDelete: Cascade)
  voyage  Voyage?     @relation(fields: [voyageId], references: [id], onDelete: SetNull)
  
  @@index([routeId, completed])
  @@index([voyageId])
  @@map("route_quality_logs")
}

// Learned route patterns from historical AIS data
model LearnedRoutePattern {
  id              String   @id @default(cuid())
  
  // Route identification
  originPortId    String
  destPortId      String
  vesselType      String   // 'container', 'tanker', 'bulk_carrier', 'general_cargo'
  
  // Pattern metadata
  patternName     String   // E.g., "Singapore-Rotterdam Northern Route"
  description     String?
  
  // Learning statistics
  observedCount   Int      @default(1) // How many times observed in AIS data
  firstObservedAt DateTime @default(now())
  lastObservedAt  DateTime @default(now())
  
  // Pattern characteristics
  avgDistanceNm   Float
  avgDurationHours Float
  avgSpeedKnots   Float
  
  // Seasonal patterns
  preferredMonths String?  // JSON array [1,2,3...] or "all"
  
  // Pattern quality
  reliability     Float    @default(0.5) // 0-1, based on consistency
  popularity      Float    @default(0.5) // 0-1, based on usage frequency
  
  // Waypoint pattern (simplified)
  waypointPattern Json     // Simplified waypoint coordinates
  
  // Relations
  originPort Port @relation("LearnedPatternOrigin", fields: [originPortId], references: [id])
  destPort   Port @relation("LearnedPatternDest", fields: [destPortId], references: [id])
  
  @@unique([originPortId, destPortId, vesselType, patternName])
  @@index([vesselType, reliability])
  @@index([observedCount])
  @@map("learned_route_patterns")
}

// Route constraints based on vessel characteristics
model RouteConstraint {
  id              String   @id @default(cuid())
  
  // Constraint identification
  constraintType  String   // 'PORT_DEPTH', 'CANAL_WIDTH', 'STRAIT_DRAFT', 'ECA_ZONE', 'HIGH_RISK'
  locationName    String   // Name of the constrained area
  
  // Geographic area (polygon or point)
  latitude        Float?
  longitude       Float?
  radiusNm        Float?   // For circular areas
  boundaryGeoJson Json?    // For complex polygons
  
  // Vessel-specific limits
  maxDraftMeters  Float?
  maxLoaMeters    Float?
  maxBeamMeters   Float?
  
  // Operational constraints
  speedLimitKnots Float?
  pilotRequired   Boolean  @default(false)
  tideDependent   Boolean  @default(false)
  
  // Applies to vessel types
  appliesToContainer Boolean @default(true)
  appliesToTanker    Boolean @default(true)
  appliesToBulk      Boolean @default(true)
  appliesToGeneral   Boolean @default(true)
  
  // Active status
  isActive        Boolean  @default(true)
  validFrom       DateTime @default(now())
  validUntil      DateTime?
  
  // Source of constraint
  source          String   // 'PORT_AUTHORITY', 'IMO', 'LEARNED', 'MANUAL'
  notes           String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([constraintType, isActive])
  @@index([locationName])
  @@map("route_constraints")
}

// Real-time route optimization suggestions (auto-learning output)
model RouteOptimizationSuggestion {
  id              String   @id @default(cuid())
  
  // Target route
  originalRouteId String
  voyageId        String?
  
  // Suggestion details
  suggestionType  String   // 'FASTER', 'CHEAPER', 'SAFER', 'AVOID_CONGESTION'
  reason          String   // Why this suggestion was made
  
  // Predicted improvements
  timeSavingHours Float?
  fuelSavingMt    Float?
  costSavingUsd   Float?
  
  // Alternative route
  alternativeRouteId String?
  alternativeWaypoints Json? // If no existing route
  
  // Confidence
  confidence      Float    @default(0.5) // 0-1, based on learning data
  
  // User feedback (learning loop)
  accepted        Boolean?
  acceptedAt      DateTime?
  acceptedBy      String?
  actualOutcome   String?  // User feedback on result
  
  // Auto-expire
  validUntil      DateTime
  status          String   @default("ACTIVE") // 'ACTIVE', 'ACCEPTED', 'REJECTED', 'EXPIRED'
  
  createdAt       DateTime @default(now())
  
  @@index([originalRouteId, status])
  @@index([voyageId])
  @@index([createdAt])
  @@map("route_optimization_suggestions")
}


// ============================================================================
// PRE-ARRIVAL INTELLIGENCE SYSTEM (Agent Wedge Strategy)
// ============================================================================

// === Vessel Arrival Tracking ===

model VesselArrival {
  id              String   @id @default(cuid())
  vesselId        String
  portId          String
  triggeredAt     DateTime @default(now())

  // Distance & Position
  distance        Float    // Distance to port in NM when triggered
  latitude        Float    // Position when triggered
  longitude       Float

  // ETA Calculations
  etaBestCase     DateTime // Fastest possible arrival
  etaMostLikely   DateTime // Most probable arrival time
  etaWorstCase    DateTime // Slowest likely arrival
  etaConfidence   ArrivalConfidence // high, medium, low
  etaFactors      String[] // Factors affecting ETA

  // Current Status
  status          ArrivalStatus @default(APPROACHING)
  currentDistance Float?        // Updated as vessel approaches
  lastUpdateAt    DateTime      @default(now())

  // Actual Arrival
  actualArrivalAt DateTime?
  actualEtaVariance Float?    // Hours difference from etaMostLikely

  // Relations
  vessel          Vessel   @relation("VesselArrivals", fields: [vesselId], references: [id], onDelete: Cascade)
  port            Port     @relation("PortArrivals", fields: [portId], references: [id], onDelete: Cascade)

  intelligence    ArrivalIntelligence?
  documentStatuses DocumentStatus[]
  masterAlerts    MasterAlert[]
  timelineEvents  ArrivalTimelineEvent[]
  daForecastAccuracy DAForecastAccuracy[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([vesselId, status])
  @@index([portId, status])
  @@index([status, etaMostLikely])
  @@index([triggeredAt])
  @@map("vessel_arrivals")
}

enum ArrivalStatus {
  APPROACHING
  IN_ANCHORAGE
  BERTHING
  BERTHED
  WORKING
  UNBERTHING
  DEPARTED
  CANCELLED
}

enum ArrivalConfidence {
  HIGH
  MEDIUM
  LOW
}

// === Arrival Intelligence ===

model ArrivalIntelligence {
  id              String   @id @default(cuid())
  arrivalId       String   @unique

  // Document Intelligence
  documentsRequired     Int
  documentsMissing      Int
  documentsSubmitted    Int
  documentsApproved     Int
  complianceScore       Float
  criticalDocsMissing   String[]
  nextDocumentDeadline  DateTime?

  // DA Cost Intelligence
  daEstimateMin         Float?
  daEstimateMax         Float?
  daEstimateMostLikely  Float?
  daConfidence          Float?
  daBreakdown           Json?
  daFactors             String[]
  daHistoricalComparison String?

  // Congestion Intelligence
  congestionStatus      CongestionStatus @default(GREEN)
  expectedWaitTimeMin   Float?
  expectedWaitTimeMax   Float?
  vesselsInPort         Int?
  vesselsAtAnchorage    Int?
  congestionFactors     String[]

  // Port Readiness
  portReadinessScore    String   @default("green")
  berthAvailability     String?
  pilotAvailability     String?
  tugAvailability       String?

  // Recommendations
  recommendations       Json?
  optimizedSpeed        Float?

  // Accuracy Tracking
  etaAccuracy           Float?
  daAccuracy            Float?
  congestionAccuracy    Float?

  // Relations
  arrival         VesselArrival @relation(fields: [arrivalId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([arrivalId])
  @@index([congestionStatus])
  @@index([complianceScore])
  @@map("arrival_intelligence")
}

enum CongestionStatus {
  GREEN
  YELLOW
  RED
}

// === Document Status Tracking ===

model DocumentStatus {
  id              String   @id @default(cuid())
  arrivalId       String
  documentType    String

  // Requirement Info
  required        Boolean  @default(true)
  mandatory       Boolean  @default(true)
  priority        DocumentPriority
  deadline        DateTime
  hoursRemaining  Float?

  // Status Tracking
  status          DocumentSubmissionStatus @default(NOT_STARTED)
  submittedAt     DateTime?
  submittedBy     String?
  approvedAt      DateTime?
  approvedBy      String?
  rejectedAt      DateTime?
  rejectionReason String?

  // File Info
  fileUrl         String?
  fileName        String?
  fileSize        Int?

  // Metadata
  notes           String?
  metadata        Json?

  // Relations
  arrival         VesselArrival @relation(fields: [arrivalId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([arrivalId, documentType])
  @@index([arrivalId, status])
  @@index([status, deadline])
  @@index([documentType])
  @@map("document_statuses")
}

enum DocumentPriority {
  CRITICAL
  IMPORTANT
  ROUTINE
}

enum DocumentSubmissionStatus {
  NOT_STARTED
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
  OVERDUE
}

// === Master Alerts ===

model MasterAlert {
  id              String   @id @default(cuid())
  arrivalId       String
  vesselId        String

  // Alert Details
  alertType       MasterAlertType
  title           String
  message         String
  priority        AlertPriority

  // Delivery Channels
  channels        String[]
  recipientEmail  String?
  recipientPhone  String?

  // Delivery Status
  sentAt          DateTime?
  deliveredAt     DateTime?
  readAt          DateTime?
  acknowledgedAt  DateTime?

  // Two-Way Communication
  repliedAt       DateTime?
  reply           String?
  replyParsed     Json?
  actionTaken     String?

  // Relations
  arrival         VesselArrival @relation(fields: [arrivalId], references: [id], onDelete: Cascade)
  vessel          Vessel        @relation("VesselMasterAlerts", fields: [vesselId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([arrivalId])
  @@index([vesselId])
  @@index([alertType, priority])
  @@index([sentAt])
  @@map("master_alerts")
}

enum MasterAlertType {
  ARRIVAL_200NM
  DOCUMENT_MISSING
  DEADLINE_APPROACHING
  CONGESTION_HIGH
  DA_COST_HIGH
  ETA_CHANGED
  PORT_READINESS_RED
  ACTION_REQUIRED
}

enum AlertPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

// === Arrival Timeline Events ===

model ArrivalTimelineEvent {
  id              String   @id @default(cuid())
  arrivalId       String
  timestamp       DateTime @default(now())

  // Event Details
  eventType       ArrivalEventType
  actor           EventActor
  action          String
  impact          EventImpact?

  // Event Data
  metadata        Json?
  attachments     String[]
  relatedEvents   String[]

  // Relations
  arrival         VesselArrival @relation(fields: [arrivalId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([arrivalId, timestamp])
  @@index([eventType])
  @@index([actor])
  @@map("arrival_timeline_events")
}

enum ArrivalEventType {
  ARRIVAL_DETECTED
  ETA_CALCULATED
  ETA_UPDATED
  INTELLIGENCE_GENERATED
  CONGESTION_DETECTED
  ALERT_TRIGGERED
  DOCUMENT_REQUIRED
  DOCUMENT_SUBMITTED
  DOCUMENT_APPROVED
  DOCUMENT_REJECTED
  DOCUMENT_OVERDUE
  PDA_GENERATED
  MASTER_ALERTED
  SERVICE_BOOKED
  FDA_SUBMITTED
  ALERT_ACKNOWLEDGED
  DOCUMENT_UPLOADED
  STATUS_UPDATED
  DELAY_REPORTED
  DISTANCE_UPDATED
  ANCHORAGE_REACHED
  BERTH_ASSIGNED
  BERTHING_COMPLETE
  DEPARTURE
}

enum EventActor {
  SYSTEM
  AGENT
  MASTER
  OWNER
  AUTHORITY
}

enum EventImpact {
  CRITICAL
  IMPORTANT
  INFO
}

// === DA Forecast Accuracy (ML Feedback Loop) ===

model DAForecastAccuracy {
  id              String   @id @default(cuid())
  arrivalId       String
  vesselId        String
  portId          String

  // Prediction
  predictedMin    Float
  predictedMax    Float
  predictedMostLikely Float
  predictionConfidence Float
  predictionDate  DateTime @default(now())

  // Actual
  actualCost      Float?
  actualDate      DateTime?

  // Accuracy Metrics
  absoluteError   Float?
  percentageError Float?
  withinRange     Boolean?

  // Features (for ML retraining)
  vesselGT        Float?
  vesselLOA       Float?
  vesselDraft     Float?
  cargoType       String?
  season          String?
  dwellTimeHours  Float?

  // Relations
  arrival         VesselArrival @relation(fields: [arrivalId], references: [id], onDelete: Cascade)
  vessel          Vessel        @relation("VesselDAForecasts", fields: [vesselId], references: [id], onDelete: Cascade)
  port            Port          @relation("PortDAForecasts", fields: [portId], references: [id], onDelete: Cascade)

  createdAt       DateTime @default(now())

  @@index([arrivalId])
  @@index([vesselId])
  @@index([portId])
  @@index([predictionDate])
  @@map("da_forecast_accuracy")
}

// === Beta Program Models ===

model BetaAgentProfile {
  id                String    @id @default(cuid())
  organizationId    String    @unique
  agentName         String
  serviceTypes      String[]  // port_agent, surveyor, bunker_supplier, ship_chandler
  portsCoverage     String[]  // array of port IDs
  credentials       Json?     // agent credentials (IMO member ID, port authority license, etc.)
  slaAcceptedAt     DateTime?
  slaVersion        String?
  apiKey            String?   @unique
  apiKeyGeneratedAt DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@map("beta_agent_profiles")
}

model BetaFeedback {
  id             String    @id @default(cuid())
  organizationId String?
  userId         String?
  rating         Int       // 1-5
  category       String    // UI, Performance, Features, Documentation, Support
  feedback       String
  screenshot     String?   // URL to uploaded screenshot
  url            String?   // Page where feedback was submitted
  browser        String?
  userAgent      String?
  createdAt      DateTime  @default(now())

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdAt])
  @@map("beta_feedback")
}

model BugReport {
  id                String    @id @default(cuid())
  organizationId    String?
  userId            String?
  title             String
  description       String
  severity          String    // CRITICAL, HIGH, MEDIUM, LOW
  stepsToReproduce  String?
  screenshot        String?
  url               String?
  browser           String?
  userAgent         String?
  status            String    @default("new") // new, investigating, in_progress, resolved, wont_fix
  resolvedAt        DateTime?
  resolvedBy        String?
  resolution        String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  organization      Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user              User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([severity, status])
  @@index([organizationId])
  @@map("bug_reports")
}

model FeatureRequest {
  id             String    @id @default(cuid())
  organizationId String?
  userId         String?
  title          String
  description    String
  priority       String?   // HIGH, MEDIUM, LOW
  votes          Int       @default(1)
  status         String    @default("submitted") // submitted, reviewing, planned, in_progress, completed, rejected
  completedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([votes])
  @@index([status])
  @@map("feature_requests")
}

model BetaTrainingProgress {
  id          String   @id @default(cuid())
  userId      String
  videoId     String?
  tutorialId  String?
  completedAt DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, videoId])
  @@unique([userId, tutorialId])
  @@index([userId])
  @@map("beta_training_progress")
}

// ============================================================================
// KNOWLEDGE BASE & TRAINING MATERIALS (Phase 5.5)
// ============================================================================

model KnowledgeArticle {
  id                  String   @id @default(cuid())
  title               String
  slug                String   @unique
  category            String   // getting_started, features, api_docs, troubleshooting, best_practices, video_tutorials, faqs, release_notes
  difficulty          String   // beginner, intermediate, advanced
  content             String   @db.Text // Markdown content
  excerpt             String
  tags                String[]
  videoUrl            String?
  estimatedReadTime   Int?     // minutes
  published           Boolean  @default(false)
  views               Int      @default(0)
  helpfulCount        Int      @default(0)
  notHelpfulCount     Int      @default(0)
  authorId            String
  relatedArticleIds   String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  author              User     @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([category])
  @@index([published])
  @@index([slug])
  @@index([createdAt])
  @@map("knowledge_articles")
}

model ArticleProgress {
  id            String    @id @default(cuid())
  userId        String
  articleId     String
  completed     Boolean   @default(false)
  progress      Int       @default(0) // 0-100
  timeSpent     Int       @default(0) // seconds
  lastViewedAt  DateTime  @default(now())
  completedAt   DateTime?

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
  @@index([completed])
  @@map("article_progress")
}

model LearningPath {
  id                 String   @id @default(cuid())
  title              String
  description        String
  articleIds         String[] // Ordered list of article IDs
  estimatedTotalTime Int      // minutes
  category           String
  difficulty         String   // beginner, intermediate, advanced
  published          Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([category])
  @@index([published])
  @@map("learning_paths")
}

// ============================================================================
// Email Organizer - Phase 4
// Complete email management with folders, threading, AI summaries, and responses
// ============================================================================

model EmailFolder {
  id             String   @id @default(cuid())
  userId         String
  organizationId String
  organization   Organization @relation("EmailFolders", fields: [organizationId], references: [id], onDelete: Cascade)

  name           String
  type           String // system, custom, bucket
  icon           String?
  color          String?
  position       Int     @default(0)

  parentId       String?
  parent         EmailFolder?  @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children       EmailFolder[] @relation("FolderHierarchy")

  rules          Json?
  unreadCount    Int     @default(0)
  totalCount     Int     @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
  @@index([organizationId])
  @@index([type])
  @@index([parentId])
  @@map("email_folders")
}

model EmailThread {
  id              String   @id @default(cuid())
  userId          String
  organizationId  String
  organization    Organization @relation("EmailThreads", fields: [organizationId], references: [id], onDelete: Cascade)

  subject         String
  participants    String[]
  messageCount    Int     @default(0)
  unreadCount     Int     @default(0)

  firstMessageId  String?
  latestMessageId String?

  category        String?
  urgency         String?
  urgencyScore    Int?
  actionable      String?

  labels          String[]
  isStarred       Boolean  @default(false)
  isArchived      Boolean  @default(false)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([category])
  @@index([urgency])
  @@index([isStarred])
  @@map("email_threads")
}

model ResponseDraft {
  id             String   @id @default(cuid())
  emailId        String
  userId         String
  organizationId String
  organization   Organization @relation("ResponseDrafts", fields: [organizationId], references: [id], onDelete: Cascade)

  style          String
  subject        String
  body           String   @db.Text

  contextDocs    Json?
  contextKnowledge Json?
  threadHistory  Json?

  status         String   @default("draft")
  confidence     Float?

  edits          ResponseEdit[]

  sentAt         DateTime?
  deliveredAt    DateTime?
  readAt         DateTime?
  repliedAt      DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([emailId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@map("response_drafts")
}

model ResponseEdit {
  id             String   @id @default(cuid())
  draftId        String
  draft          ResponseDraft @relation(fields: [draftId], references: [id], onDelete: Cascade)

  field          String
  originalValue  String @db.Text
  editedValue    String @db.Text
  reason         String?

  editedAt       DateTime @default(now())

  @@index([draftId])
  @@map("response_edits")
}

model EmailNotification {
  id             String   @id @default(cuid())
  emailId        String?
  userId         String
  organizationId String
  organization   Organization @relation("EmailNotifications", fields: [organizationId], references: [id], onDelete: Cascade)

  type           String
  title          String
  body           String?
  channels       String[]

  sentAt         DateTime @default(now())
  readAt         DateTime?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([userId])
  @@index([organizationId])
  @@index([emailId])
  @@index([type])
  @@map("email_notifications")
}

model EmailFolderRule {
  id             String   @id @default(cuid())
  folderId       String
  userId         String
  organizationId String

  conditions     Json
  name           String
  description    String?
  enabled        Boolean  @default(true)
  priority       Int     @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([folderId])
  @@index([userId])
  @@map("email_folder_rules")
}


// Mari8XOSRM - Extracted AIS Routes (for route learning)
model ExtractedAISRoute {
  id String @id @default(cuid())

  // Vessel information
  vesselId   String
  vesselType String

  // Port pair
  originPortId String
  destPortId   String

  // Voyage timing
  departureTime DateTime
  arrivalTime   DateTime

  // Distance metrics
  greatCircleNm  Float
  actualSailedNm Float
  distanceFactor Float
  durationHours  Float
  avgSpeedKnots  Float

  // Quality metrics
  qualityScore    Float
  coveragePercent Float
  totalPositions  Int

  // Route classification
  routeType String
  viaPoints String[]

  // Simplified position data
  positionsData Json?

  // Metadata
  extractedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([vesselId])
  @@index([originPortId, destPortId])
  @@index([vesselType])
  @@index([qualityScore])
  @@index([routeType])
  @@map("extracted_ais_routes")
}
