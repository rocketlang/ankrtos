# Mari8X - E2E Network Deployment Guide

Complete guide to deploy Mari8X on E2E Network VPS with nginx and Cloudflare SSL.

---

## Architecture

```
Internet
    â†“
Cloudflare (SSL/CDN) - mari8x.com
    â†“
E2E Network VPS (Your Server)
    â†“
nginx (Port 80/443)
    â”œâ”€ / â†’ Frontend (React static files)
    â”œâ”€ /api/* â†’ Backend (Node.js :4051)
    â””â”€ /graphql â†’ Backend (GraphQL API)

Backend Stack:
- Node.js 20 + Fastify
- PostgreSQL database
- PM2 process manager
- GraphQL API (Mercurius)
```

---

## Prerequisites

**On your E2E Network server, you need:**
- Ubuntu 20.04+ or Debian 11+
- Root or sudo access
- At least 2GB RAM
- 20GB storage
- Public IP address

**Domain setup:**
- Domain: mari8x.com (already owned)
- DNS managed by Cloudflare

---

## Initial Deployment

### Step 1: Connect to E2E Network Server

```bash
ssh user@your-e2e-server-ip
```

### Step 2: Clone Repository (on your local machine first)

```bash
# On your local machine
cd /root
git add apps/ankr-maritime/deploy-mari8x.sh
git add apps/ankr-maritime/update-mari8x.sh
git commit -m "Add E2E Network deployment scripts"
git push origin master
```

### Step 3: Run Deployment Script (on E2E server)

```bash
# On E2E server
cd ~
curl -O https://raw.githubusercontent.com/rocketlang/dodd-icd/master/apps/ankr-maritime/deploy-mari8x.sh
chmod +x deploy-mari8x.sh
./deploy-mari8x.sh
```

**The script will:**
1. âœ… Install Node.js 20, PM2, PostgreSQL, nginx
2. âœ… Create PostgreSQL database (mari8x)
3. âœ… Clone repository to `/var/www/mari8x`
4. âœ… Build backend (TypeScript â†’ JavaScript)
5. âœ… Run database migrations
6. âœ… Build frontend (React â†’ static files)
7. âœ… Start backend with PM2
8. âœ… Configure nginx

**Duration:** ~10-15 minutes

---

## Step 4: Configure Environment Variables

**Edit backend .env file:**

```bash
sudo nano /var/www/mari8x/apps/ankr-maritime/backend/.env
```

**Update these values:**

```bash
NODE_ENV=production
PORT=4051
DATABASE_URL=postgresql://mari8x:CHANGE_THIS_PASSWORD@localhost:5432/mari8x
JWT_SECRET=<auto-generated, keep as is>
FRONTEND_URL=https://mari8x.com
ENABLE_AIS=false
```

**Change the database password:**

```bash
# Set new password in PostgreSQL
sudo -u postgres psql -c "ALTER USER mari8x WITH PASSWORD 'your_secure_password_here';"

# Update .env file with same password
DATABASE_URL=postgresql://mari8x:your_secure_password_here@localhost:5432/mari8x
```

**Restart backend:**

```bash
pm2 restart mari8x-backend
```

---

## Step 5: Cloudflare DNS Configuration

### A. Point Domain to E2E Server

1. Go to Cloudflare dashboard
2. Select **mari8x.com** domain
3. Click **DNS** â†’ **Records**
4. Add/Update A record:
   - **Type**: A
   - **Name**: @ (or mari8x.com)
   - **IPv4 address**: `<your E2E server IP>`
   - **Proxy status**: âœ… Proxied (orange cloud)
   - **TTL**: Auto

5. Add www subdomain (optional):
   - **Type**: CNAME
   - **Name**: www
   - **Target**: mari8x.com
   - **Proxy status**: âœ… Proxied

### B. Configure SSL/TLS

1. In Cloudflare: **SSL/TLS** â†’ **Overview**
2. Set encryption mode: **Full** (not "Full (strict)" unless you setup origin certificate)
3. Enable **Always Use HTTPS**
4. Enable **Automatic HTTPS Rewrites**

**SSL will be auto-provisioned by Cloudflare in ~1-2 minutes**

---

## Step 6: Verify Deployment

### Check Backend Status

```bash
# Check PM2 status
pm2 status

# View logs
pm2 logs mari8x-backend --lines 50

# Check if backend is responding
curl http://localhost:4051/health
# Should return: {"status":"ok","service":"ankr-maritime",...}
```

### Check nginx

```bash
# Test configuration
sudo nginx -t

# Check status
sudo systemctl status nginx

# View error logs (if any)
sudo tail -f /var/log/nginx/error.log
```

### Check PostgreSQL

```bash
# Connect to database
sudo -u postgres psql -d mari8x

# List tables
\dt

# Exit
\q
```

### Test in Browser

1. Open **https://mari8x.com** (wait for DNS propagation, can take 5-10 minutes)
2. You should see the Mari8X login page
3. Try logging in: `admin@ankr.in` / `admin123`
4. Navigate to: **https://mari8x.com/flow-canvas** to see Flow Canvas

**If DNS hasn't propagated yet, test with server IP:**
```bash
curl -H "Host: mari8x.com" http://YOUR_SERVER_IP/health
```

---

## Updating Mari8X (Future Deployments)

When you push new code to GitHub, run this on E2E server:

```bash
cd /var/www/mari8x/apps/ankr-maritime
./update-mari8x.sh
```

**Or manually:**

```bash
cd /var/www/mari8x
git pull origin master

# Update backend
cd apps/ankr-maritime/backend
npm install --legacy-peer-deps
npx prisma migrate deploy
npm run build
pm2 restart mari8x-backend

# Update frontend
cd ../frontend
npm install --legacy-peer-deps
npm run build

# Reload nginx
sudo systemctl reload nginx
```

---

## Useful Commands

### PM2 (Backend Process Manager)

```bash
# View status
pm2 status

# View logs (real-time)
pm2 logs mari8x-backend

# View last 100 lines
pm2 logs mari8x-backend --lines 100

# Restart backend
pm2 restart mari8x-backend

# Stop backend
pm2 stop mari8x-backend

# Start backend
pm2 start mari8x-backend

# View process info
pm2 info mari8x-backend

# Monitor CPU/memory
pm2 monit
```

### nginx

```bash
# Test configuration
sudo nginx -t

# Reload (graceful restart)
sudo systemctl reload nginx

# Restart
sudo systemctl restart nginx

# Status
sudo systemctl status nginx

# View error logs
sudo tail -f /var/log/nginx/error.log

# View access logs
sudo tail -f /var/log/nginx/access.log
```

### PostgreSQL

```bash
# Connect to database
sudo -u postgres psql -d mari8x

# Backup database
sudo -u postgres pg_dump mari8x > mari8x_backup_$(date +%Y%m%d).sql

# Restore database
sudo -u postgres psql -d mari8x < mari8x_backup_20260207.sql

# View database size
sudo -u postgres psql -d mari8x -c "SELECT pg_size_pretty(pg_database_size('mari8x'));"
```

### System Resources

```bash
# Check disk space
df -h

# Check memory
free -h

# Check CPU usage
htop  # or top

# Check which process is using port 4051
sudo lsof -i :4051

# Check Node.js processes
ps aux | grep node
```

---

## Troubleshooting

### Backend won't start

```bash
# Check logs
pm2 logs mari8x-backend --err --lines 50

# Common issues:
# 1. Database connection error â†’ Check .env DATABASE_URL
# 2. Port already in use â†’ Kill process: sudo lsof -ti:4051 | xargs kill -9
# 3. Prisma client error â†’ Regenerate: cd backend && npx prisma generate
```

### Frontend shows blank page

```bash
# Check if files exist
ls -lh /var/www/mari8x/apps/ankr-maritime/frontend/dist/

# Rebuild frontend
cd /var/www/mari8x/apps/ankr-maritime/frontend
npm run build

# Check nginx error log
sudo tail -f /var/log/nginx/error.log
```

### Can't connect to database

```bash
# Check PostgreSQL status
sudo systemctl status postgresql

# Start PostgreSQL
sudo systemctl start postgresql

# Test connection
sudo -u postgres psql -d mari8x -c "SELECT 1;"
```

### SSL certificate not working

1. Check Cloudflare SSL mode is "Full" (not Flexible)
2. Wait 10-15 minutes for certificate provisioning
3. Clear browser cache
4. Try incognito mode

### "502 Bad Gateway" error

```bash
# Backend is down - check PM2
pm2 status
pm2 restart mari8x-backend

# Check if backend is listening
curl http://localhost:4051/health
```

---

## Security Checklist

- âœ… Change default database password in .env
- âœ… Use strong JWT_SECRET (auto-generated)
- âœ… Enable Cloudflare proxy (orange cloud)
- âœ… Keep Node.js and npm updated
- âœ… Regular database backups
- âœ… Monitor PM2 logs for suspicious activity
- âœ… Use firewall (ufw) to restrict ports:
  ```bash
  sudo ufw allow 22    # SSH
  sudo ufw allow 80    # HTTP
  sudo ufw allow 443   # HTTPS
  sudo ufw enable
  ```

---

## Performance Optimization

### Enable HTTP/2 in nginx

```bash
sudo nano /etc/nginx/sites-available/mari8x.com

# Change:
listen 443 ssl;
# To:
listen 443 ssl http2;

sudo nginx -t && sudo systemctl reload nginx
```

### Enable nginx caching

```bash
# Add to nginx config (inside http block)
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m use_temp_path=off;

# Add to location /api/ block
proxy_cache my_cache;
proxy_cache_valid 200 5m;
```

### PM2 Cluster Mode (for high traffic)

```bash
# Edit ecosystem.config.cjs
instances: 'max',  # Use all CPU cores

pm2 restart mari8x-backend
```

---

## Backup Strategy

### Automated Daily Backups

Create backup script:

```bash
sudo nano /usr/local/bin/backup-mari8x.sh
```

```bash
#!/bin/bash
BACKUP_DIR="/var/backups/mari8x"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# Backup database
sudo -u postgres pg_dump mari8x | gzip > $BACKUP_DIR/mari8x_db_$DATE.sql.gz

# Backup uploaded files (if any)
# tar -czf $BACKUP_DIR/mari8x_files_$DATE.tar.gz /var/www/mari8x/uploads

# Keep only last 7 days
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete

echo "Backup completed: $DATE"
```

```bash
chmod +x /usr/local/bin/backup-mari8x.sh

# Add to crontab (daily at 2am)
sudo crontab -e
# Add line:
0 2 * * * /usr/local/bin/backup-mari8x.sh >> /var/log/mari8x-backup.log 2>&1
```

---

## Monitoring

### Setup basic monitoring

```bash
# PM2 monitoring dashboard (free)
pm2 register

# Or use PM2 web interface
pm2 web
# Access at http://YOUR_SERVER_IP:9615
```

---

## Summary

**Deployment Status:**
- âœ… Backend running on port 4051 (PM2)
- âœ… Frontend built as static files
- âœ… nginx reverse proxy configured
- âœ… PostgreSQL database setup
- âœ… SSL via Cloudflare
- âœ… Domain: mari8x.com

**Access Points:**
- **Website**: https://mari8x.com
- **Flow Canvas**: https://mari8x.com/flow-canvas
- **GraphQL API**: https://mari8x.com/graphql
- **GraphiQL IDE**: https://mari8x.com/graphiql
- **Health Check**: https://mari8x.com/health

**Next Steps:**
1. Run deployment script on E2E server
2. Update database password in .env
3. Configure Cloudflare DNS
4. Test in browser
5. Enjoy! ðŸš€
