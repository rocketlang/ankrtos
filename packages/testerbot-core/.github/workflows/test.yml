name: TesterBot Tests

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Run Desktop Smoke Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type smoke --report json --output ./test-results
        continue-on-error: true

      - name: Run Web Smoke Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app web --type smoke --report json --output ./test-results
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: smoke-test-results
          path: packages/testerbot-cli/test-results/
          retention-days: 30

      - name: Upload screenshots
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: smoke-test-screenshots
          path: packages/testerbot-cli/test-results/screenshots/
          retention-days: 7

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: smoke-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Run E2E Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type e2e --report json --output ./test-results
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: packages/testerbot-cli/test-results/
          retention-days: 30

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: smoke-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Run Performance Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type performance --report json --output ./test-results
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: performance-test-results
          path: packages/testerbot-cli/test-results/
          retention-days: 30

  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: smoke-tests

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Restore visual baselines
        uses: actions/cache@v3
        with:
          path: packages/testerbot-cli/test-results/visual-baselines/
          key: visual-baselines-${{ github.ref }}-${{ hashFiles('packages/**/*.ts') }}
          restore-keys: |
            visual-baselines-${{ github.ref }}-
            visual-baselines-

      - name: Run Visual Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type visual --report json --output ./test-results
        continue-on-error: true

      - name: Upload visual diffs
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: visual-diffs
          path: packages/testerbot-cli/test-results/visual-diffs/
          retention-days: 7

      - name: Save visual baselines
        uses: actions/cache@v3
        if: success()
        with:
          path: packages/testerbot-cli/test-results/visual-baselines/
          key: visual-baselines-${{ github.ref }}-${{ hashFiles('packages/**/*.ts') }}

  stress-chaos-tests:
    name: Stress & Chaos Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [e2e-tests, performance-tests]
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Run Stress Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type stress --report json --output ./test-results
        continue-on-error: true

      - name: Run Chaos Tests
        run: |
          cd packages/testerbot-cli
          node dist/cli.js run --app desktop --type chaos --report json --output ./test-results
        continue-on-error: true

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: resilience-test-results
          path: packages/testerbot-cli/test-results/
          retention-days: 30

  report:
    name: Generate Test Report
    runs-on: ubuntu-latest
    needs: [smoke-tests, e2e-tests, performance-tests, visual-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download all test results
        uses: actions/download-artifact@v3
        with:
          path: test-results/

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm -r build

      - name: Generate HTML Report
        run: |
          cd packages/testerbot-cli
          # Combine all JSON results and generate HTML report
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { Reporter } = require('./dist/index.js');

          const resultsDir = '../../test-results';
          const reports = [];

          // Find all JSON test results
          function findJsonFiles(dir) {
            const files = fs.readdirSync(dir, { withFileTypes: true });
            for (const file of files) {
              const fullPath = path.join(dir, file.name);
              if (file.isDirectory()) {
                findJsonFiles(fullPath);
              } else if (file.name.endsWith('.json') && file.name.includes('report')) {
                try {
                  const report = JSON.parse(fs.readFileSync(fullPath, 'utf8'));
                  reports.push(report);
                } catch (e) {
                  console.log('Error reading', fullPath, e.message);
                }
              }
            }
          }

          findJsonFiles(resultsDir);

          if (reports.length > 0) {
            // Combine reports
            const combined = {
              summary: {
                total: reports.reduce((sum, r) => sum + (r.summary?.total || 0), 0),
                passed: reports.reduce((sum, r) => sum + (r.summary?.passed || 0), 0),
                failed: reports.reduce((sum, r) => sum + (r.summary?.failed || 0), 0),
                skipped: reports.reduce((sum, r) => sum + (r.summary?.skipped || 0), 0)
              },
              results: reports.flatMap(r => r.results || []),
              startTime: Math.min(...reports.map(r => r.startTime || Date.now())),
              endTime: Math.max(...reports.map(r => r.endTime || Date.now()))
            };

            Reporter.saveHTML(combined, './test-results');
          }
          "

      - name: Upload HTML Report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: html-test-report
          path: packages/testerbot-cli/test-results/*.html
          retention-days: 30

      - name: Comment PR with results
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Find and read test results
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = 0;

            try {
              const resultsDir = 'test-results';
              const findResults = (dir) => {
                const files = fs.readdirSync(dir, { withFileTypes: true });
                for (const file of files) {
                  const fullPath = path.join(dir, file.name);
                  if (file.isDirectory()) {
                    findResults(fullPath);
                  } else if (file.name.endsWith('.json') && file.name.includes('report')) {
                    const report = JSON.parse(fs.readFileSync(fullPath, 'utf8'));
                    totalTests += report.summary?.total || 0;
                    passedTests += report.summary?.passed || 0;
                    failedTests += report.summary?.failed || 0;
                  }
                }
              };
              findResults(resultsDir);
            } catch (e) {
              console.log('Error reading results:', e);
            }

            const passRate = totalTests > 0 ? ((passedTests / totalTests) * 100).toFixed(1) : 0;
            const status = failedTests === 0 ? 'âœ…' : 'âŒ';

            const comment = `## ${status} TesterBot Test Results

            | Metric | Value |
            |--------|-------|
            | Total Tests | ${totalTests} |
            | Passed | âœ… ${passedTests} |
            | Failed | âŒ ${failedTests} |
            | Pass Rate | ${passRate}% |

            ${failedTests > 0 ? 'âš ï¸ Some tests failed. Please review the test artifacts.' : 'ğŸ‰ All tests passed!'}

            <details>
            <summary>View Test Details</summary>

            Check the workflow artifacts for detailed test results, screenshots, and reports.

            - **Smoke Tests**: Basic functionality validation
            - **E2E Tests**: Complete user workflows
            - **Performance Tests**: Performance benchmarks
            - **Visual Tests**: UI consistency checks

            </details>
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
